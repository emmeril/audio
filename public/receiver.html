<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Stream - Penerima</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/debug.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .audio-wave {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 40px;
        }
        
        .audio-bar {
            width: 3px;
            margin: 0 1px;
            background: linear-gradient(to top, #10b981, #3b82f6);
            border-radius: 2px;
            animation: audioWave 1.5s ease-in-out infinite;
        }
        
        .audio-bar:nth-child(1) { animation-delay: 0.0s; height: 10px; }
        .audio-bar:nth-child(2) { animation-delay: 0.1s; height: 20px; }
        .audio-bar:nth-child(3) { animation-delay: 0.2s; height: 30px; }
        .audio-bar:nth-child(4) { animation-delay: 0.3s; height: 40px; }
        .audio-bar:nth-child(5) { animation-delay: 0.4s; height: 30px; }
        .audio-bar:nth-child(6) { animation-delay: 0.5s; height: 20px; }
        .audio-bar:nth-child(7) { animation-delay: 0.6s; height: 10px; }
        
        @keyframes audioWave {
            0%, 100% { height: 10px; }
            50% { height: 40px; }
        }
        
        .equalizer-bar {
            width: 4px;
            background: linear-gradient(to top, #3b82f6, #8b5cf6);
            border-radius: 2px;
            animation: equalizer 1.5s ease-in-out infinite;
        }
        
        @keyframes equalizer {
            0%, 100% { height: 10px; }
            25% { height: 40px; }
            50% { height: 20px; }
            75% { height: 30px; }
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .volume-slider {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right, #d1d5db, #9ca3af);
            outline: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        .volume-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div x-data="receiverApp()" x-init="init()" class="min-h-screen">
        <!-- Header -->
        <header class="bg-white/10 backdrop-blur-sm border-b border-white/20">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <a href="/" class="flex items-center space-x-2 text-white hover:text-white/80 transition">
                            <span class="text-2xl">‚Üê</span>
                            <span>Kembali</span>
                        </a>
                        <div class="h-6 w-px bg-white/30"></div>
                        <div>
                            <h1 class="text-xl font-bold text-white">üéß Mode Penerima</h1>
                            <p class="text-white/80 text-sm">Dengarkan audio streaming</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="glass-card px-4 py-2 rounded-lg">
                            <div class="flex items-center">
                                <div class="status-indicator" :class="isConnected ? 'bg-green-400 animate-pulse' : 'bg-gray-400'"></div>
                                <span class="text-white text-sm" x-text="isConnected ? 'Terhubung' : 'Menghubungkan...'"></span>
                            </div>
                        </div>
                        
                        <div class="glass-card px-4 py-2 rounded-lg" x-show="roomCode">
                            <div class="text-white text-sm">
                                <span class="opacity-80">Room:</span>
                                <span class="font-bold ml-2" x-text="roomCode"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            <div class="max-w-4xl mx-auto">
                <!-- Connection Card -->
                <div class="bg-white rounded-2xl shadow-2xl p-8 mb-8 fade-in">
                    <div class="flex flex-col md:flex-row items-center justify-between mb-8">
                        <div class="mb-6 md:mb-0">
                            <h2 class="text-3xl font-bold text-gray-800 mb-2">Status Koneksi</h2>
                            <p class="text-gray-600" x-text="connectionStatus"></p>
                        </div>
                        
                        <div class="flex items-center space-x-4">
                            <button @click="leaveRoom()"
                                    class="bg-gray-100 text-gray-700 hover:bg-gray-200 px-6 py-3 rounded-xl transition font-semibold">
                                üö™ Keluar Room
                            </button>
                            
                            <button @click="reconnect()"
                                    :disabled="isConnecting"
                                    class="bg-blue-100 text-blue-700 hover:bg-blue-200 px-6 py-3 rounded-xl transition font-semibold flex items-center">
                                <template x-if="isConnecting">
                                    <svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </template>
                                <span x-text="isConnecting ? 'Menyambung...' : 'üîÅ Sambung Ulang'"></span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Connection Progress -->
                    <div class="mb-8">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-gray-700 font-medium">Progress Koneksi</span>
                            <span class="text-sm font-semibold" :class="{
                                'text-green-600': connectionProgress >= 100,
                                'text-yellow-600': connectionProgress >= 50 && connectionProgress < 100,
                                'text-red-600': connectionProgress < 50
                            }" x-text="connectionProgress + '%'"></span>
                        </div>
                        <div class="h-3 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full transition-all duration-500"
                                 :style="`width: ${connectionProgress}%`"></div>
                        </div>
                        
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="text-center p-4 bg-gray-50 rounded-lg" :class="{ 'bg-green-50 border border-green-200': connectionStep >= 1 }">
                                <div class="text-2xl mb-2">üîå</div>
                                <p class="font-semibold" :class="{ 'text-green-600': connectionStep >= 1 }">Socket</p>
                                <p class="text-sm text-gray-500" x-text="socketConnected ? 'Connected' : 'Connecting...'"></p>
                            </div>
                            
                            <div class="text-center p-4 bg-gray-50 rounded-lg" :class="{ 'bg-green-50 border border-green-200': connectionStep >= 2 }">
                                <div class="text-2xl mb-2">üéØ</div>
                                <p class="font-semibold" :class="{ 'text-green-600': connectionStep >= 2 }">Room</p>
                                <p class="text-sm text-gray-500" x-text="roomCode || 'Waiting'"></p>
                            </div>
                            
                            <div class="text-center p-4 bg-gray-50 rounded-lg" :class="{ 'bg-green-50 border border-green-200': connectionStep >= 3 }">
                                <div class="text-2xl mb-2">üì°</div>
                                <p class="font-semibold" :class="{ 'text-green-600': connectionStep >= 3 }">Peer</p>
                                <p class="text-sm text-gray-500" x-text="peerConnection ? 'Connected' : 'Waiting'"></p>
                            </div>
                            
                            <div class="text-center p-4 bg-gray-50 rounded-lg" :class="{ 'bg-green-50 border border-green-200': connectionStep >= 4 }">
                                <div class="text-2xl mb-2">üîä</div>
                                <p class="font-semibold" :class="{ 'text-green-600': connectionStep >= 4 }">Audio</p>
                                <p class="text-sm text-gray-500" x-text="isAudioPlaying ? 'Playing' : 'Waiting'"></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Audio Controls -->
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-6 mb-6">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">üéöÔ∏è Kontrol Audio</h3>
                                <p class="text-gray-600">Atur volume dan kontrol pemutaran</p>
                            </div>
                            
                            <div class="text-right">
                                <p class="text-sm text-gray-500">Status</p>
                                <p class="font-semibold" :class="isAudioPlaying ? 'text-green-600' : 'text-yellow-600'"
                                   x-text="isAudioPlaying ? 'Memutar Audio' : 'Menunggu Audio'"></p>
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            <!-- Volume Control -->
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-gray-700 font-medium">Volume</span>
                                    <span class="text-blue-600 font-bold" x-text="volume + '%'"></span>
                                </div>
                                <input type="range" 
                                       x-model="volume" 
                                       @input="updateVolume($event.target.value)"
                                       min="0" 
                                       max="100" 
                                       class="volume-slider w-full">
                                
                                <div class="flex justify-between text-xs text-gray-400 mt-1">
                                    <span>0%</span>
                                    <span>25%</span>
                                    <span>50%</span>
                                    <span>75%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                            
                            <!-- Playback Controls -->
                            <div class="flex justify-center space-x-4">
                                <button @click="toggleAudio()"
                                        :disabled="!audioStream"
                                        :class="!audioStream ? 'bg-gray-300 cursor-not-allowed' : isAudioPlaying ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'"
                                        class="text-white px-8 py-3 rounded-xl font-semibold transition">
                                    <span x-text="isAudioPlaying ? '‚è∏Ô∏è Jeda' : '‚ñ∂Ô∏è Putar'"></span>
                                </button>
                                
                                <button @click="testAudioPlayback()"
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold transition">
                                    üîä Test Audio
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Audio Visualization & Info -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Audio Visualization -->
                    <div class="bg-white rounded-2xl shadow-2xl p-8">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6">üìä Visualisasi Audio</h3>
                        
                        <div class="mb-8">
                            <div class="flex justify-center mb-4">
                                <div class="audio-wave">
                                    <template x-for="i in 7" :key="i">
                                        <div class="audio-bar" :style="`height: ${getBarHeight(i)}px; animation-delay: ${(i-1)*0.1}s`"></div>
                                    </template>
                                </div>
                            </div>
                            
                            <div class="text-center">
                                <p class="text-gray-600 mb-2">Level Audio</p>
                                <div class="inline-block bg-gray-100 px-4 py-2 rounded-full">
                                    <span class="font-bold text-lg" :class="{
                                        'text-green-600': audioLevel >= 50,
                                        'text-yellow-600': audioLevel >= 20 && audioLevel < 50,
                                        'text-red-600': audioLevel < 20
                                    }" x-text="audioLevel + '%'"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Equalizer -->
                        <div class="mt-8">
                            <p class="text-gray-700 font-medium mb-4">Equalizer Simulasi</p>
                            <div class="flex items-end justify-center h-32 space-x-1">
                                <template x-for="i in 10" :key="i">
                                    <div class="equalizer-bar" :style="`height: ${getEqualizerHeight(i)}px; animation-delay: ${i*0.15}s`"></div>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Connection Info -->
                    <div class="bg-white rounded-2xl shadow-2xl p-8">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6">‚ÑπÔ∏è Informasi Koneksi</h3>
                        
                        <div class="space-y-4">
                            <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="status-indicator" :class="{
                                        'bg-green-500': connectionState === 'connected',
                                        'bg-yellow-500': connectionState === 'connecting',
                                        'bg-red-500': connectionState === 'failed'
                                    }"></div>
                                    <span class="text-gray-700">Status Peer</span>
                                </div>
                                <span class="font-semibold capitalize" x-text="connectionState"></span>
                            </div>
                            
                            <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                                <span class="text-gray-700">Kode Room</span>
                                <span class="font-semibold text-blue-600" x-text="roomCode || '-'"></span>
                            </div>
                            
                            <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                                <span class="text-gray-700">Host ID</span>
                                <span class="font-semibold text-gray-800" x-text="hostId ? hostId.substring(0, 8) + '...' : 'Menunggu'"></span>
                            </div>
                            
                            <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                                <span class="text-gray-700">Kualitas Koneksi</span>
                                <span class="font-semibold" :class="{
                                    'text-green-600': connectionQuality === 'Excellent',
                                    'text-yellow-600': connectionQuality === 'Good',
                                    'text-red-600': connectionQuality === 'Poor'
                                }" x-text="connectionQuality"></span>
                            </div>
                            
                            <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                                <span class="text-gray-700">Waktu Koneksi</span>
                                <span class="font-semibold text-gray-800" x-text="connectionTime"></span>
                            </div>
                            
                            <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                                <span class="text-gray-700">Retry Attempts</span>
                                <span class="font-semibold" :class="{
                                    'text-green-600': retryCount === 0,
                                    'text-yellow-600': retryCount > 0 && retryCount <= 3,
                                    'text-red-600': retryCount > 3
                                }" x-text="retryCount"></span>
                            </div>
                        </div>
                        
                        <!-- Stats -->
                        <div class="mt-8 pt-8 border-t border-gray-200">
                            <h4 class="font-bold text-gray-700 mb-4">üìà Statistik</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-center p-3 bg-blue-50 rounded-lg">
                                    <p class="text-2xl font-bold text-blue-600" x-text="bytesReceived"></p>
                                    <p class="text-sm text-gray-600">Bytes Received</p>
                                </div>
                                <div class="text-center p-3 bg-purple-50 rounded-lg">
                                    <p class="text-2xl font-bold text-purple-600" x-text="packetsLost"></p>
                                    <p class="text-sm text-gray-600">Packets Lost</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Instructions -->
                <div class="mt-8 bg-white/10 backdrop-blur-sm rounded-2xl p-8">
                    <h3 class="text-2xl font-bold text-white mb-6">üìã Panduan Troubleshooting</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white/20 p-6 rounded-xl">
                            <h4 class="font-bold text-white mb-3 flex items-center">
                                <span class="mr-2">üîä</span> Tidak Ada Audio?
                            </h4>
                            <ul class="space-y-2">
                                <li class="flex items-start">
                                    <span class="text-white mr-2">‚Ä¢</span>
                                    <span class="text-white/90">Periksa volume komputer dan browser</span>
                                </li>
                                <li class="flex items-start">
                                    <span class="text-white mr-2">‚Ä¢</span>
                                    <span class="text-white/90">Klik tombol "Test Audio" di atas</span>
                                </li>
                                <li class="flex items-start">
                                    <span class="text-white mr-2">‚Ä¢</span>
                                    <span class="text-white/90">Refresh halaman dan coba lagi</span>
                                </li>
                            </ul>
                        </div>
                        
                        <div class="bg-white/20 p-6 rounded-xl">
                            <h4 class="font-bold text-white mb-3 flex items-center">
                                <span class="mr-2">üîó</span> Koneksi Terputus?
                            </h4>
                            <ul class="space-y-2">
                                <li class="flex items-start">
                                    <span class="text-white mr-2">‚Ä¢</span>
                                    <span class="text-white/90">Klik "Sambung Ulang"</span>
                                </li>
                                <li class="flex items-start">
                                    <span class="text-white mr-2">‚Ä¢</span>
                                    <span class="text-white/90">Pastikan pengirim masih streaming</span>
                                </li>
                                <li class="flex items-start">
                                    <span class="text-white mr-2">‚Ä¢</span>
                                    <span class="text-white/90">Coba dengan room code baru</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Status Bar -->
        <div class="fixed bottom-0 left-0 right-0 bg-black/80 backdrop-blur-sm text-white py-3 px-4">
            <div class="container mx-auto">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <div class="status-indicator" :class="statusColor"></div>
                            <span x-text="statusMessage"></span>
                        </div>
                        <div class="text-sm opacity-75 hidden md:block" x-text="statusDetail"></div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-sm opacity-75" x-text="connectionTime"></div>
                        <div class="text-sm opacity-75">
                            Latensi: <span x-text="latency + 'ms'"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hidden Audio Element -->
        <audio x-ref="audioElement" 
               autoplay
               playsinline
               class="hidden">
            Browser Anda tidak mendukung elemen audio.
        </audio>
    </div>

    <script>
        function receiverApp() {
            return {
                // State
                socket: null,
                roomCode: '',
                hostId: null,
                isConnected: false,
                isConnecting: false,
                isAudioPlaying: false,
                peerConnection: null,
                audioStream: null,
                socketConnected: false,
                
                // Status
                statusMessage: 'Memuat aplikasi...',
                statusDetail: 'Mengambil kode room dari URL...',
                statusColor: 'bg-yellow-500',
                
                // Connection info
                connectionState: 'disconnected',
                connectionStatus: 'Menghubungkan...',
                connectionProgress: 0,
                connectionStep: 0,
                connectionQuality: 'Unknown',
                connectionTime: '00:00',
                connectionStartTime: null,
                
                // Stats
                volume: 70,
                audioLevel: 0,
                bytesReceived: 0,
                packetsLost: 0,
                latency: 0,
                retryCount: 0,
                
                // Audio context for analysis
                audioContext: null,
                analyser: null,
                audioDataArray: null,
                
                // Initialization
                async init() {
                    console.log('üéß Initializing receiver application...');
                    
                    // Get room code from URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const roomParam = urlParams.get('room');
                    
                    if (!roomParam) {
                        this.showError('Kode room tidak ditemukan', 'Tambahkan parameter ?room=KODE di URL');
                        return;
                    }
                    
                    this.roomCode = roomParam.toUpperCase();
                    this.updateStatus(`Menggunakan room: ${this.roomCode}`, 'bg-blue-500');
                    
                    // Start connection timer
                    this.connectionStartTime = new Date();
                    this.updateConnectionTime();
                    
                    // Initialize socket connection
                    await this.initializeSocket();
                    
                    // Initialize audio context for visualization
                    this.initializeAudioContext();
                },
                
                // Initialize audio context for visualization
                initializeAudioContext() {
                    try {
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        this.analyser = this.audioContext.createAnalyser();
                        this.analyser.fftSize = 256;
                        this.audioDataArray = new Uint8Array(this.analyser.frequencyBinCount);
                        console.log('‚úÖ Audio context initialized');
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Audio context not available:', error);
                    }
                },
                
                // Socket initialization
                async initializeSocket() {
                    try {
                        this.isConnecting = true;
                        this.connectionStep = 1;
                        this.updateConnectionProgress();
                        this.updateStatus('Menghubungkan ke server...', 'bg-blue-500');
                        
                        this.socket = io({
                            transports: ['websocket', 'polling'],
                            reconnectionAttempts: 5,
                            reconnectionDelay: 1000
                        });
                        
                        // Connection events
                        this.socket.on('connect', () => {
                            console.log('‚úÖ Socket connected:', this.socket.id);
                            this.socketConnected = true;
                            this.connectionStep = 2;
                            this.updateConnectionProgress();
                            this.updateStatus(`Terhubung ke server`, 'bg-green-500');
                            
                            // Join room as listener
                            this.socket.emit('join-room', this.roomCode, 'listener');
                        });
                        
                        this.socket.on('room-joined', (data) => {
                            console.log('üéâ Room joined:', data);
                            this.hostId = data.hostId;
                            this.connectionStep = 3;
                            this.updateConnectionProgress();
                            
                            if (data.isStreaming) {
                                this.updateStatus('Pengirim sedang streaming', 'bg-green-500', 'Menyiapkan koneksi audio...');
                                this.initializePeerConnection();
                            } else {
                                this.updateStatus('Menunggu pengirim mulai streaming...', 'bg-yellow-500');
                                this.connectionStatus = 'Menunggu host memulai streaming';
                            }
                        });
                        
                        this.socket.on('host-streaming-started', (data) => {
                            console.log('üé¨ Host started streaming:', data.hostId);
                            this.updateStatus('Pengirim mulai streaming!', 'bg-green-500', 'Menyiapkan koneksi audio...');
                            this.connectionStatus = 'Menyambungkan ke audio stream...';
                            this.initializePeerConnection();
                        });
                        
                        this.socket.on('host-streaming-stopped', () => {
                            console.log('üõë Host stopped streaming');
                            this.updateStatus('Pengirim berhenti streaming', 'bg-yellow-500');
                            this.connectionStatus = 'Menunggu pengirim mulai lagi...';
                            this.stopAudio();
                        });
                        
                        this.socket.on('host-disconnected', () => {
                            console.log('‚ö†Ô∏è Host disconnected');
                            this.updateStatus('Pengirim keluar dari room', 'bg-red-500');
                            this.connectionStatus = 'Host telah keluar';
                            this.stopAudio();
                            this.showError('Pengirim keluar', 'Room telah ditutup oleh pengirim');
                        });
                        
                        // Handle SDP offers - DIPERBAIKI
                        this.socket.on('sdp-offer', async (data) => {
                            console.log('üì• Received SDP offer from:', data.senderId);
                            console.log('Offer details:', data.offer);
                            
                            this.hostId = data.senderId;
                            
                            if (!this.peerConnection) {
                                await this.initializePeerConnection();
                            }
                            
                            await this.handleOffer(data.offer);
                        });
                        
                        // Handle SDP answers (just in case)
                        this.socket.on('sdp-answer', (data) => {
                            console.log('Received SDP answer:', data);
                        });
                        
                        // Handle ICE candidates - DIPERBAIKI
                        this.socket.on('ice-candidate', async (data) => {
                            console.log('‚ùÑÔ∏è Received ICE candidate:', data);
                            
                            if (this.peerConnection && data.candidate) {
                                try {
                                    const candidate = new RTCIceCandidate(data.candidate);
                                    await this.peerConnection.addIceCandidate(candidate);
                                    console.log('‚úÖ ICE candidate added successfully');
                                } catch (error) {
                                    console.error('‚ùå Error adding ICE candidate:', error);
                                    // Continue anyway, some ICE candidates might be redundant
                                }
                            }
                        });
                        
                        // Connection requested by host
                        this.socket.on('connection-requested', (data) => {
                            console.log('Connection requested by host:', data);
                        });
                        
                        // Socket errors
                        this.socket.on('connect_error', (error) => {
                            console.error('‚ùå Socket connection error:', error);
                            this.socketConnected = false;
                            this.connectionStep = 1;
                            this.updateConnectionProgress();
                            this.updateStatus('Gagal menghubungkan ke server', 'bg-red-500');
                            this.connectionStatus = 'Connection failed. Retrying...';
                            this.retryCount++;
                        });
                        
                        this.socket.on('disconnect', (reason) => {
                            console.log('‚ö†Ô∏è Socket disconnected:', reason);
                            this.socketConnected = false;
                            this.connectionStep = 1;
                            this.updateConnectionProgress();
                            this.updateStatus('Terputus dari server', 'bg-red-500');
                            this.connectionStatus = 'Disconnected from server';
                        });
                        
                        // Initial connection
                        this.socket.connect();
                        
                    } catch (error) {
                        console.error('‚ùå Error initializing socket:', error);
                        this.updateStatus('Gagal menghubungkan', 'bg-red-500', error.message);
                        this.isConnecting = false;
                    }
                },
                
                // Initialize WebRTC peer connection - DIPERBAIKI
                async initializePeerConnection() {
                    try {
                        this.connectionState = 'connecting';
                        this.updateStatus('Menyiapkan koneksi peer-to-peer...', 'bg-blue-500');
                        
                        // Close existing connection if any
                        if (this.peerConnection) {
                            this.peerConnection.close();
                            this.peerConnection = null;
                        }
                        
                        const configuration = {
                            iceServers: [
                                { urls: 'stun:stun.l.google.com:19302' },
                                { urls: 'stun:stun1.l.google.com:19302' },
                                { urls: 'stun:stun2.l.google.com:19302' },
                                { urls: 'stun:stun3.l.google.com:19302' }
                            ],
                            iceTransportPolicy: 'all',
                            bundlePolicy: 'max-bundle',
                            rtcpMuxPolicy: 'require',
                            encodedInsertableStreams: false
                        };
                        
                        this.peerConnection = new RTCPeerConnection(configuration);
                        
                        // Handle incoming tracks - DIPERBAIKI
                        this.peerConnection.ontrack = (event) => {
                            console.log('üéµ Received track event:', event);
                            console.log('Track kind:', event.track.kind);
                            console.log('Streams:', event.streams);
                            console.log('Track details:', {
                                enabled: event.track.enabled,
                                muted: event.track.muted,
                                readyState: event.track.readyState,
                                kind: event.track.kind,
                                id: event.track.id,
                                label: event.track.label
                            });
                            
                            if (event.streams && event.streams[0]) {
                                const stream = event.streams[0];
                                console.log('Stream received with tracks:', stream.getTracks().map(t => t.kind));
                                
                                // Setup audio element with stream
                                this.setupAudioStream(stream);
                            } else if (event.track) {
                                // Create a new stream with the track
                                const stream = new MediaStream([event.track]);
                                console.log('Created new stream from track:', event.track.kind);
                                
                                // Setup audio element with stream
                                this.setupAudioStream(stream);
                            }
                        };
                        
                        // ICE connection state
                        this.peerConnection.oniceconnectionstatechange = () => {
                            const state = this.peerConnection.iceConnectionState;
                            this.connectionState = state;
                            console.log('ICE connection state changed:', state);
                            
                            switch(state) {
                                case 'checking':
                                    this.updateStatus('Mengecek koneksi ICE...', 'bg-blue-500');
                                    this.connectionStatus = 'Establishing connection...';
                                    break;
                                case 'connected':
                                case 'completed':
                                    this.updateStatus('Koneksi peer berhasil!', 'bg-green-500');
                                    this.connectionStatus = 'Peer connection established';
                                    this.connectionQuality = 'Excellent';
                                    this.isConnected = true;
                                    break;
                                case 'disconnected':
                                    this.updateStatus('Koneksi terputus', 'bg-yellow-500');
                                    this.connectionStatus = 'Connection lost. Attempting to reconnect...';
                                    this.connectionQuality = 'Poor';
                                    this.retryConnection();
                                    break;
                                case 'failed':
                                    this.updateStatus('Koneksi gagal', 'bg-red-500');
                                    this.connectionStatus = 'Connection failed';
                                    this.connectionQuality = 'Poor';
                                    this.retryConnection();
                                    break;
                                case 'closed':
                                    this.updateStatus('Koneksi ditutup', 'bg-gray-500');
                                    this.connectionStatus = 'Connection closed';
                                    this.isConnected = false;
                                    break;
                            }
                        };
                        
                        // ICE gathering state
                        this.peerConnection.onicegatheringstatechange = () => {
                            console.log('ICE gathering state:', this.peerConnection.iceGatheringState);
                        };
                        
                        // ICE candidates - DIPERBAIKI
                        this.peerConnection.onicecandidate = (event) => {
                            if (event.candidate && this.hostId && this.socket) {
                                console.log('Sending ICE candidate to host:', event.candidate);
                                this.socket.emit('ice-candidate', {
                                    roomId: this.roomCode,
                                    candidate: event.candidate,
                                    to: this.hostId
                                });
                            } else if (!event.candidate) {
                                console.log('‚úÖ ICE gathering complete');
                            }
                        };
                        
                        // Connection state
                        this.peerConnection.onconnectionstatechange = () => {
                            console.log('Connection state:', this.peerConnection.connectionState);
                        };
                        
                        // Signaling state
                        this.peerConnection.onsignalingstatechange = () => {
                            console.log('Signaling state:', this.peerConnection.signalingState);
                        };
                        
                        // Request connection from host if we have hostId
                        if (this.hostId && this.socket) {
                            console.log('Requesting connection from host:', this.hostId);
                            this.socket.emit('request-connection', {
                                roomId: this.roomCode,
                                listenerId: this.socket.id
                            });
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Error initializing peer connection:', error);
                        this.updateStatus('Gagal membuat koneksi peer', 'bg-red-500', error.message);
                        this.connectionState = 'failed';
                        this.retryConnection();
                    } finally {
                        this.isConnecting = false;
                    }
                },
                
                // Setup audio stream - DIPERBAIKI
                async setupAudioStream(stream) {
                    try {
                        this.audioStream = stream;
                        this.$refs.audioElement.srcObject = this.audioStream;
                        
                        // Setup audio visualization if audio context is available
                        if (this.audioContext && this.analyser) {
                            const source = this.audioContext.createMediaStreamSource(stream);
                            source.connect(this.analyser);
                            console.log('‚úÖ Audio visualization connected');
                        }
                        
                        // Try to play audio
                        await this.playAudio();
                        
                        this.isAudioPlaying = true;
                        this.isConnected = true;
                        this.connectionStep = 4;
                        this.updateConnectionProgress();
                        this.connectionState = 'connected';
                        
                        this.updateStatus('Audio streaming aktif!', 'bg-green-500', 'Nikmati audio dari pengirim');
                        this.connectionStatus = 'Audio streaming aktif';
                        this.connectionQuality = 'Excellent';
                        
                        // Start audio level monitoring
                        this.startAudioLevelMonitoring();
                        
                        // Start connection quality monitoring
                        this.startConnectionMonitoring();
                        
                    } catch (error) {
                        console.error('Error setting up audio stream:', error);
                        this.updateStatus('Gagal memutar audio', 'bg-red-500', error.message);
                    }
                },
                
                // Play audio - DIPERBAIKI
                async playAudio() {
                    try {
                        // Set volume
                        this.$refs.audioElement.volume = this.volume / 100;
                        
                        // Try to play
                        const playPromise = this.$refs.audioElement.play();
                        
                        if (playPromise !== undefined) {
                            await playPromise;
                            console.log('‚úÖ Audio playback started successfully');
                            return true;
                        }
                    } catch (error) {
                        console.error('Error playing audio:', error);
                        
                        // Try different approaches
                        try {
                            // Try with user interaction simulation
                            this.$refs.audioElement.muted = false;
                            this.$refs.audioElement.volume = 0.1;
                            await this.$refs.audioElement.play();
                            console.log('‚úÖ Audio playback started with reduced volume');
                            return true;
                        } catch (secondError) {
                            console.error('Second attempt failed:', secondError);
                            
                            // Show user instruction
                            this.updateStatus('Klik tombol play untuk memulai audio', 'bg-yellow-500');
                            this.showNotification('Klik tombol Play untuk memulai audio', 'warning');
                            return false;
                        }
                    }
                },
                
                // Handle SDP offer from host - DIPERBAIKI
                async handleOffer(offer) {
                    try {
                        if (!this.peerConnection) {
                            console.error('No peer connection available');
                            await this.initializePeerConnection();
                        }
                        
                        console.log('Setting remote description...');
                        await this.peerConnection.setRemoteDescription(
                            new RTCSessionDescription(offer)
                        );
                        
                        console.log('Creating answer...');
                        const answer = await this.peerConnection.createAnswer({
                            offerToReceiveAudio: true,
                            offerToReceiveVideo: false
                        });
                        
                        console.log('Setting local description...');
                        await this.peerConnection.setLocalDescription(answer);
                        
                        console.log('Sending answer to host...');
                        this.socket.emit('sdp-answer', {
                            roomId: this.roomCode,
                            answer: answer,
                            to: this.hostId
                        });
                        
                        console.log('‚úÖ SDP answer sent successfully');
                        
                    } catch (error) {
                        console.error('‚ùå Error handling SDP offer:', error);
                        this.updateStatus('Gagal menangani offer', 'bg-red-500', error.message);
                        
                        // Try to reinitialize connection
                        setTimeout(() => {
                            this.retryConnection();
                        }, 1000);
                    }
                },
                
                // Start audio level monitoring - DIPERBAIKI
                startAudioLevelMonitoring() {
                    const updateLevel = () => {
                        if (this.isAudioPlaying && this.audioStream && this.analyser) {
                            // Get audio data from analyser
                            this.analyser.getByteFrequencyData(this.audioDataArray);
                            
                            // Calculate average volume
                            let sum = 0;
                            for (let i = 0; i < this.audioDataArray.length; i++) {
                                sum += this.audioDataArray[i];
                            }
                            const average = sum / this.audioDataArray.length;
                            
                            // Convert to percentage (0-100)
                            this.audioLevel = Math.min(100, (average / 255) * 100);
                            
                            // Simulate bytes received
                            this.bytesReceived += Math.floor(Math.random() * 1000);
                            
                            // Simulate occasional packet loss
                            if (Math.random() < 0.05) { // 5% chance
                                this.packetsLost += Math.floor(Math.random() * 3);
                            }
                            
                            // Simulate latency
                            this.latency = 30 + Math.floor(Math.random() * 40);
                        } else if (this.isAudioPlaying) {
                            // Fallback simulation
                            this.audioLevel = 30 + Math.random() * 50;
                            this.bytesReceived += Math.floor(Math.random() * 500);
                            this.latency = 50 + Math.floor(Math.random() * 50);
                        } else {
                            this.audioLevel = 0;
                        }
                        
                        // Continue monitoring
                        if (this.isAudioPlaying) {
                            requestAnimationFrame(updateLevel);
                        }
                    };
                    
                    updateLevel();
                },
                
                // Start connection monitoring
                startConnectionMonitoring() {
                    setInterval(() => {
                        if (this.peerConnection && this.peerConnection.iceConnectionState === 'connected') {
                            // Update connection quality based on simulated metrics
                            if (this.packetsLost > 50) {
                                this.connectionQuality = 'Poor';
                            } else if (this.packetsLost > 20) {
                                this.connectionQuality = 'Good';
                            } else {
                                this.connectionQuality = 'Excellent';
                            }
                        }
                    }, 3000);
                },
                
                // Retry connection
                async retryConnection() {
                    this.retryCount++;
                    
                    if (this.retryCount > 5) {
                        this.updateStatus('Gagal menyambung setelah beberapa percobaan', 'bg-red-500');
                        this.showError('Koneksi gagal', 'Coba refresh halaman atau gunakan room code berbeda');
                        return;
                    }
                    
                    this.updateStatus(`Mencoba sambung ulang (${this.retryCount}/5)...`, 'bg-yellow-500');
                    
                    // Close existing connection
                    if (this.peerConnection) {
                        this.peerConnection.close();
                        this.peerConnection = null;
                    }
                    
                    this.stopAudio();
                    
                    // Wait before retrying
                    setTimeout(async () => {
                        await this.initializePeerConnection();
                    }, 1000 * this.retryCount);
                },
                
                // Update connection progress
                updateConnectionProgress() {
                    this.connectionProgress = this.connectionStep * 25;
                },
                
                // Update connection time
                updateConnectionTime() {
                    if (!this.connectionStartTime) return;
                    
                    const now = new Date();
                    const diff = Math.floor((now - this.connectionStartTime) / 1000);
                    
                    const hours = Math.floor(diff / 3600);
                    const minutes = Math.floor((diff % 3600) / 60);
                    const seconds = diff % 60;
                    
                    this.connectionTime = 
                        (hours > 0 ? hours.toString().padStart(2, '0') + ':' : '') +
                        minutes.toString().padStart(2, '0') + ':' +
                        seconds.toString().padStart(2, '0');
                    
                    // Update every second
                    setTimeout(() => this.updateConnectionTime(), 1000);
                },
                
                // Audio controls
                updateVolume(value) {
                    this.volume = value;
                    if (this.$refs.audioElement) {
                        this.$refs.audioElement.volume = value / 100;
                    }
                },
                
                toggleAudio() {
                    if (!this.audioStream) {
                        this.showNotification('Tidak ada audio stream tersedia', 'warning');
                        return;
                    }
                    
                    if (this.isAudioPlaying) {
                        this.$refs.audioElement.pause();
                        this.isAudioPlaying = false;
                        this.updateStatus('Audio dijeda', 'bg-yellow-500');
                    } else {
                        this.playAudio()
                            .then(success => {
                                if (success) {
                                    this.isAudioPlaying = true;
                                    this.updateStatus('Audio diputar', 'bg-green-500');
                                }
                            })
                            .catch(error => {
                                console.error('Error playing audio:', error);
                                this.isAudioPlaying = false;
                            });
                    }
                },
                
                stopAudio() {
                    this.isAudioPlaying = false;
                    if (this.$refs.audioElement) {
                        this.$refs.audioElement.pause();
                        this.$refs.audioElement.srcObject = null;
                    }
                    this.audioStream = null;
                },
                
                // Test audio playback - DIPERBAIKI
                async testAudioPlayback() {
                    try {
                        // Test 1: Simple beep sound using Web Audio API
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.value = 440; // A4 note
                        oscillator.type = 'sine';
                        
                        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                        
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.5);
                        
                        this.showNotification('Test audio diputar (suara beep)', 'success');
                        
                        // Test 2: Check if audio element can play
                        setTimeout(() => {
                            const testAudio = new Audio();
                            testAudio.src = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ';
                            testAudio.volume = 0.3;
                            
                            testAudio.play()
                                .then(() => {
                                    console.log('‚úÖ Audio element test passed');
                                })
                                .catch(error => {
                                    console.warn('‚ö†Ô∏è Audio element test failed:', error);
                                    this.showNotification('Browser mungkin memblokir audio otomatis', 'warning');
                                });
                        }, 600);
                        
                    } catch (error) {
                        console.error('Audio test error:', error);
                        this.showError('Test Audio Gagal', 'Browser Anda mungkin memblokir audio. Pastikan izin audio diaktifkan.');
                    }
                },
                
                // Helper methods
                reconnect() {
                    this.retryCount = 0;
                    this.connectionStep = 1;
                    this.updateConnectionProgress();
                    
                    if (this.peerConnection) {
                        this.peerConnection.close();
                        this.peerConnection = null;
                    }
                    
                    this.stopAudio();
                    this.initializePeerConnection();
                },
                
                leaveRoom() {
                    if (confirm('Apakah Anda yakin ingin keluar dari room?')) {
                        window.location.href = '/';
                    }
                },
                
                getBarHeight(index) {
                    if (!this.isAudioPlaying) return 10;
                    
                    // Use real audio data if available
                    if (this.analyser && this.audioDataArray) {
                        const dataIndex = Math.floor((index / 7) * this.audioDataArray.length);
                        return 10 + (this.audioDataArray[dataIndex] / 255) * 30;
                    }
                    
                    // Fallback simulation
                    const baseHeight = 10;
                    const variation = Math.sin(Date.now() / 500 + index) * 15;
                    return baseHeight + variation + (index * 2);
                },
                
                getEqualizerHeight(index) {
                    if (!this.isAudioPlaying) return 10;
                    
                    // Use real audio data if available
                    if (this.analyser && this.audioDataArray) {
                        const dataIndex = Math.floor((index / 10) * this.audioDataArray.length);
                        return 10 + (this.audioDataArray[dataIndex] / 255) * 30;
                    }
                    
                    // Fallback simulation
                    const baseHeight = 10;
                    const variation = Math.sin(Date.now() / 300 + index * 0.5) * 20;
                    return baseHeight + variation;
                },
                
                updateStatus(message, color = 'bg-blue-500', detail = '') {
                    this.statusMessage = message;
                    this.statusColor = color;
                    this.statusDetail = detail;
                },
                
                showError(title, message) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg z-50';
                    errorDiv.innerHTML = `
                        <div class="flex items-center">
                            <span class="mr-3">‚ö†Ô∏è</span>
                            <div>
                                <p class="font-bold">${title}</p>
                                <p class="text-sm opacity-90">${message}</p>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(errorDiv);
                    
                    setTimeout(() => {
                        errorDiv.style.opacity = '0';
                        errorDiv.style.transform = 'translate(-50%, -20px)';
                        setTimeout(() => {
                            if (errorDiv.parentNode) {
                                document.body.removeChild(errorDiv);
                            }
                        }, 300);
                    }, 5000);
                },
                
                showNotification(message, type = 'info') {
                    const icon = type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
                    const bgColor = type === 'success' ? 'bg-green-500' : type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';
                    
                    const notificationDiv = document.createElement('div');
                    notificationDiv.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300 z-50`;
                    notificationDiv.innerHTML = `
                        <div class="flex items-center">
                            <span class="mr-3">${icon}</span>
                            <span>${message}</span>
                        </div>
                    `;
                    
                    document.body.appendChild(notificationDiv);
                    
                    setTimeout(() => {
                        notificationDiv.style.transform = 'translateX(100%)';
                        notificationDiv.style.opacity = '0';
                        setTimeout(() => {
                            if (notificationDiv.parentNode) {
                                document.body.removeChild(notificationDiv);
                            }
                        }, 300);
                    }, 3000);
                }
            };
        }
    </script>
</body>
</html>