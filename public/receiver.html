<!DOCTYPE html>
<html lang="id" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioStream - Listener</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .card-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .volume-slider {
            -webkit-appearance: none;
            height: 6px;
            background: #d1d5db;
            border-radius: 3px;
            outline: none;
        }
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #10b981;
            border-radius: 50%;
            cursor: pointer;
        }
        .audio-visualizer {
            display: flex;
            align-items: flex-end;
            height: 100px;
            gap: 2px;
        }
        .audio-bar {
            width: 4px;
            background: linear-gradient(to top, #10b981, #34d399);
            border-radius: 2px;
            transition: height 0.1s ease;
        }
    </style>
</head>
<body class="h-full gradient-green">
    <div x-data="receiverApp()" x-init="init()" class="min-h-screen">
        <!-- Top Navigation -->
        <nav class="bg-white/10 backdrop-blur-sm border-b border-white/20">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-3">
                        <a href="/" class="text-white hover:text-white/80">
                            <i class="fas fa-arrow-left"></i>
                        </a>
                        <div>
                            <h1 class="text-xl font-bold text-white">Mendengarkan</h1>
                            <p class="text-white/80 text-sm" x-text="roomCode || 'Loading...'"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 rounded-full" :class="isConnected ? 'bg-green-500 animate-pulse' : 'bg-red-500'"></div>
                            <span class="text-white text-sm" x-text="isConnected ? 'Connected' : 'Disconnected'"></span>
                        </div>
                        <button @click="toggleAudio()" 
                                class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg text-sm">
                            <i class="fas" :class="isAudioPlaying ? 'fa-volume-up' : 'fa-volume-mute'"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container mx-auto px-4 py-8">
            <div class="grid lg:grid-cols-3 gap-8">
                <!-- Left Column - Audio Controls -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- Audio Player Card -->
                    <div class="card-glass rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">
                                    <i class="fas fa-headphones mr-3"></i>
                                    Audio Stream
                                </h2>
                                <p class="text-gray-600 mt-1">
                                    Mendengarkan dari: <span class="font-semibold" x-text="hostName"></span>
                                </p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-600">Kualitas</p>
                                <p class="text-xl font-bold" :class="connectionQualityClass" 
                                   x-text="connectionQuality"></p>
                            </div>
                        </div>

                        <!-- Audio Visualization -->
                        <div class="mb-8">
                            <div class="audio-visualizer" x-ref="visualizer">
                                <template x-for="i in 40" :key="i">
                                    <div class="audio-bar" :style="`height: ${Math.random() * 80 + 20}%`"></div>
                                </template>
                            </div>
                        </div>

                        <!-- Audio Controls -->
                        <div class="space-y-6">
                            <!-- Volume Control -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-medium text-gray-700">
                                        <i class="fas fa-volume-up mr-2"></i>Volume
                                    </span>
                                    <span class="font-bold text-green-600" x-text="`${volume}%`"></span>
                                </div>
                                <input type="range" 
                                       x-model="volume" 
                                       @input="updateVolume($event.target.value)"
                                       min="0" 
                                       max="100" 
                                       step="1"
                                       class="w-full volume-slider">
                            </div>

                            <!-- Control Buttons -->
                            <div class="grid grid-cols-3 gap-4">
                                <button @click="toggleAudio()"
                                        :class="isAudioPlaying ? 
                                                'bg-red-100 text-red-700 hover:bg-red-200' : 
                                                'bg-green-100 text-green-700 hover:bg-green-200'"
                                        class="py-3 rounded-xl font-semibold">
                                    <i class="fas" :class="isAudioPlaying ? 'fa-pause' : 'fa-play'"></i>
                                    <span class="ml-2" x-text="isAudioPlaying ? 'Pause' : 'Play'"></span>
                                </button>
                                
                                <button @click="reconnect()"
                                        class="bg-blue-100 text-blue-700 hover:bg-blue-200 py-3 rounded-xl font-semibold">
                                    <i class="fas fa-sync-alt"></i>
                                    <span class="ml-2">Reconnect</span>
                                </button>
                                
                                <button @click="leaveRoom()"
                                        class="bg-gray-100 text-gray-700 hover:bg-gray-200 py-3 rounded-xl font-semibold">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span class="ml-2">Leave</span>
                                </button>
                            </div>

                            <!-- Audio Info -->
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="text-sm text-gray-600">Latency</p>
                                    <p class="font-bold text-gray-800" x-text="`${latency}ms`"></p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="text-sm text-gray-600">Buffer</p>
                                    <p class="font-bold text-gray-800" x-text="`${bufferHealth}%`"></p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="text-sm text-gray-600">Uptime</p>
                                    <p class="font-bold text-gray-800" x-text="connectionTime"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Connection Status -->
                        <div class="mt-8 p-4 rounded-lg" :class="statusClass">
                            <div class="flex items-center">
                                <i class="fas" :class="statusIcon" class="text-xl mr-3"></i>
                                <div>
                                    <p class="font-semibold" x-text="statusMessage"></p>
                                    <p class="text-sm mt-1" x-text="statusDescription"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Room Info -->
                    <div class="card-glass rounded-2xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-info-circle mr-3"></i>
                            Informasi Room
                        </h3>
                        
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="p-4 bg-green-50 rounded-xl">
                                <h4 class="font-bold text-green-800 mb-2">Host Info</h4>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-green-700">Nama:</span>
                                        <span class="font-semibold" x-text="hostName"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-green-700">Room Code:</span>
                                        <span class="font-semibold font-mono" x-text="roomCode"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-green-700">Status:</span>
                                        <span class="font-semibold" 
                                              :class="isHostStreaming ? 'text-green-600' : 'text-red-600'"
                                              x-text="isHostStreaming ? 'Online' : 'Offline'">
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="p-4 bg-blue-50 rounded-xl">
                                <h4 class="font-bold text-blue-800 mb-2">Listeners</h4>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-blue-700">Total Online:</span>
                                        <span class="font-bold text-blue-800" x-text="totalListeners"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-blue-700">Anda:</span>
                                        <span class="font-semibold" x-text="listenerName"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-blue-700">Connected Since:</span>
                                        <span class="font-semibold" x-text="joinedAt"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <h4 class="font-bold text-gray-800 mb-3">Daftar Pendengar</h4>
                            <div class="space-y-2">
                                <template x-for="listener in listenerList" :key="listener.id">
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <div class="flex items-center">
                                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                                <i class="fas fa-user text-green-600 text-sm"></i>
                                            </div>
                                            <span class="font-medium" x-text="listener.name"></span>
                                        </div>
                                        <span class="text-xs text-gray-500">Online</span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Chat & Info -->
                <div class="space-y-8">
                    <!-- Chat Box -->
                    <div class="card-glass rounded-2xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-comments mr-3"></i>
                            Room Chat
                        </h3>
                        
                        <div class="space-y-4">
                            <!-- Messages -->
                            <div class="h-64 overflow-y-auto space-y-3 p-2">
                                <template x-for="message in messages" :key="message.timestamp">
                                    <div :class="message.sender === 'System' ? 
                                                 'bg-yellow-50 border-l-4 border-yellow-400' : 
                                                 message.isHost ? 'bg-blue-50' : 'bg-gray-50'"
                                         class="p-3 rounded-lg">
                                        <div class="flex justify-between items-start mb-1">
                                            <span class="font-semibold" 
                                                  :class="message.sender === 'System' ? 'text-yellow-700' : 
                                                         message.isHost ? 'text-blue-700' : 'text-gray-700'"
                                                  x-text="message.sender">
                                            </span>
                                            <span class="text-xs text-gray-500" x-text="message.timestamp"></span>
                                        </div>
                                        <p class="text-gray-800" x-text="message.message"></p>
                                    </div>
                                </template>
                            </div>
                            
                            <!-- Chat Input -->
                            <div class="flex space-x-2">
                                <input x-model="chatMessage" 
                                       @keyup.enter="sendMessage()"
                                       type="text" 
                                       placeholder="Ketik pesan..."
                                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <button @click="sendMessage()"
                                        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Instructions -->
                    <div class="card-glass rounded-2xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-lightbulb mr-3"></i>
                            Tips Mendengarkan
                        </h3>
                        
                        <div class="space-y-3">
                            <div class="flex items-start">
                                <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center mr-3 mt-1">
                                    <i class="fas fa-volume-up text-green-600 text-xs"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800">Gunakan Headphone</p>
                                    <p class="text-sm text-gray-600">Untuk pengalaman audio terbaik</p>
                                </div>
                            </div>
                            
                            <div class="flex items-start">
                                <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center mr-3 mt-1">
                                    <i class="fas fa-wifi text-blue-600 text-xs"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800">Koneksi Stabil</p>
                                    <p class="text-sm text-gray-600">Pastikan sinyal internet baik</p>
                                </div>
                            </div>
                            
                            <div class="flex items-start">
                                <div class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center mr-3 mt-1">
                                    <i class="fas fa-sync-alt text-purple-600 text-xs"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800">Reconnect jika Putus</p>
                                    <p class="text-sm text-gray-600">Klik tombol reconnect jika audio terputus</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Technical Info -->
                    <div class="card-glass rounded-2xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-cogs mr-3"></i>
                            Info Teknis
                        </h3>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-700">Protocol:</span>
                                <span class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">WebRTC</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-700">Codec Audio:</span>
                                <span class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">OPUS</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-700">Sample Rate:</span>
                                <span class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">48kHz</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-700">Bitrate:</span>
                                <span class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">128kbps</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden Audio Element -->
        <audio x-ref="audioElement" 
               autoplay
               class="hidden"
               controls>
            Browser Anda tidak mendukung audio streaming.
        </audio>
    </div>

    <script>
        function receiverApp() {
            return {
                socket: null,
                peerConnection: null,
                roomCode: '',
                listenerName: '',
                hostName: '',
                isConnected: false,
                isAudioPlaying: false,
                isHostStreaming: false,
                volume: 80,
                messages: [],
                chatMessage: '',
                listenerList: [],
                totalListeners: 0,
                connectionTime: '0m',
                latency: 0,
                bufferHealth: 100,
                connectionQuality: 'Excellent',
                connectionQualityClass: 'text-green-600',
                joinedAt: '',
                
                statusMessage: 'Menghubungkan ke room...',
                statusDescription: 'Harap tunggu sebentar',
                statusClass: 'bg-blue-100 text-blue-700',
                statusIcon: 'fa-spinner fa-spin',
                
                async init() {
                    // Get URL parameters
                    const urlParams = new URLSearchParams(window.location.search);
                    this.roomCode = urlParams.get('room');
                    this.listenerName = decodeURIComponent(urlParams.get('name') || `Listener_${Math.floor(Math.random() * 1000)}`);
                    
                    if (!this.roomCode) {
                        alert('Room tidak valid. Kembali ke halaman utama.');
                        window.location.href = '/';
                        return;
                    }
                    
                    this.joinedAt = new Date().toLocaleTimeString();
                    
                    // Connect to socket
                    this.socket = io();
                    
                    // Join room
                    this.socket.emit('join-room', {
                        roomId: this.roomCode,
                        username: this.listenerName
                    });
                    
                    // Socket event listeners
                    this.socket.on('room-joined', (data) => {
                        console.log('Joined room:', data);
                        this.hostName = data.hostName;
                        this.isHostStreaming = data.isStreaming;
                        this.totalListeners = data.totalListeners;
                        
                        this.updateStatus('Terhubung ke room', 'bg-green-100 text-green-700', 'fa-check-circle');
                        
                        if (this.isHostStreaming) {
                            this.statusMessage = 'Host sedang streaming';
                            this.statusDescription = 'Audio akan segera dimulai...';
                        }
                    });
                    
                    this.socket.on('listener-list', (listeners) => {
                        this.listenerList = listeners;
                        this.totalListeners = listeners.length;
                    });
                    
                    this.socket.on('listener-list-updated', (data) => {
                        this.totalListeners = data.totalListeners;
                    });
                    
                    this.socket.on('new-message', (message) => {
                        this.messages.push(message);
                    });
                    
                    this.socket.on('stream-started', () => {
                        this.isHostStreaming = true;
                        this.statusMessage = 'Streaming dimulai';
                        this.statusDescription = 'Menerima audio dari host...';
                    });
                    
                    this.socket.on('stream-stopped', () => {
                        this.isHostStreaming = false;
                        this.isAudioPlaying = false;
                        this.updateStatus('Streaming dihentikan', 'bg-yellow-100 text-yellow-700', 'fa-pause-circle');
                    });
                    
                    this.socket.on('host-disconnected', () => {
                        this.isHostStreaming = false;
                        this.isConnected = false;
                        this.updateStatus('Host keluar dari room', 'bg-red-100 text-red-700', 'fa-exclamation-circle');
                        
                        setTimeout(() => {
                            alert('Host telah meninggalkan room. Anda akan diarahkan ke halaman utama.');
                            window.location.href = '/';
                        }, 2000);
                    });
                    
                    this.socket.on('webrtc-offer', async (data) => {
                        await this.handleOffer(data.offer, data.from);
                    });
                    
                    this.socket.on('ice-candidate', async (data) => {
                        if (this.peerConnection && data.candidate) {
                            try {
                                await this.peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                            } catch (error) {
                                console.error('Error adding ICE candidate:', error);
                            }
                        }
                    });
                    
                    // Start connection timer
                    setInterval(() => {
                        if (this.isConnected) {
                            const now = new Date();
                            const diff = Math.floor((now - this.connectionStartTime) / 60000);
                            this.connectionTime = `${diff}m`;
                        }
                    }, 60000);
                    
                    // Update latency simulation
                    setInterval(() => {
                        if (this.isConnected) {
                            this.latency = Math.floor(Math.random() * 100) + 50;
                            this.bufferHealth = Math.floor(Math.random() * 20) + 80;
                            
                            // Update connection quality
                            if (this.latency < 100) {
                                this.connectionQuality = 'Excellent';
                                this.connectionQualityClass = 'text-green-600';
                            } else if (this.latency < 200) {
                                this.connectionQuality = 'Good';
                                this.connectionQualityClass = 'text-yellow-600';
                            } else {
                                this.connectionQuality = 'Poor';
                                this.connectionQualityClass = 'text-red-600';
                            }
                        }
                    }, 3000);
                    
                    // Animate audio visualizer
                    setInterval(() => {
                        if (this.isAudioPlaying && this.$refs.visualizer) {
                            const bars = this.$refs.visualizer.querySelectorAll('.audio-bar');
                            bars.forEach(bar => {
                                const newHeight = Math.random() * 80 + 20;
                                bar.style.height = `${newHeight}%`;
                            });
                        }
                    }, 100);
                },
                
                async handleOffer(offer, from) {
                    try {
                        const configuration = {
                            iceServers: [
                                { urls: 'stun:stun.l.google.com:19302' },
                                { urls: 'stun:stun1.l.google.com:19302' },
                                { urls: 'stun:stun2.l.google.com:19302' }
                            ]
                        };
                        
                        this.peerConnection = new RTCPeerConnection(configuration);
                        this.connectionStartTime = new Date();
                        
                        // Handle incoming stream
                        this.peerConnection.ontrack = (event) => {
                            console.log('Received stream:', event.streams[0]);
                            this.$refs.audioElement.srcObject = event.streams[0];
                            this.isConnected = true;
                            this.isAudioPlaying = true;
                            
                            this.updateStatus('Streaming aktif', 'bg-green-100 text-green-700', 'fa-volume-up');
                            
                            // Set initial volume
                            this.$refs.audioElement.volume = this.volume / 100;
                        };
                        
                        // Handle ICE candidates
                        this.peerConnection.onicecandidate = (event) => {
                            if (event.candidate) {
                                this.socket.emit('ice-candidate', {
                                    to: from,
                                    candidate: event.candidate,
                                    roomId: this.roomCode
                                });
                            }
                        };
                        
                        // Handle connection state changes
                        this.peerConnection.onconnectionstatechange = () => {
                            console.log('Connection state:', this.peerConnection.connectionState);
                            
                            if (this.peerConnection.connectionState === 'connected') {
                                this.isConnected = true;
                            } else if (this.peerConnection.connectionState === 'disconnected' || 
                                      this.peerConnection.connectionState === 'failed') {
                                this.isConnected = false;
                                this.isAudioPlaying = false;
                                this.updateStatus('Koneksi terputus', 'bg-red-100 text-red-700', 'fa-exclamation-triangle');
                            }
                        };
                        
                        await this.peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                        const answer = await this.peerConnection.createAnswer();
                        await this.peerConnection.setLocalDescription(answer);
                        
                        this.socket.emit('webrtc-answer', {
                            to: from,
                            answer: answer,
                            roomId: this.roomCode
                        });
                        
                    } catch (error) {
                        console.error('Error handling offer:', error);
                        this.updateStatus('Error menerima stream', 'bg-red-100 text-red-700', 'fa-exclamation-circle');
                    }
                },
                
                updateVolume(value) {
                    this.volume = value;
                    if (this.$refs.audioElement) {
                        this.$refs.audioElement.volume = value / 100;
                    }
                },
                
                toggleAudio() {
                    if (!this.$refs.audioElement.srcObject) return;
                    
                    this.isAudioPlaying = !this.isAudioPlaying;
                    
                    if (this.isAudioPlaying) {
                        this.$refs.audioElement.play().catch(e => {
                            console.error('Error playing audio:', e);
                            this.isAudioPlaying = false;
                        });
                    } else {
                        this.$refs.audioElement.pause();
                    }
                },
                
                reconnect() {
                    if (this.peerConnection) {
                        this.peerConnection.close();
                        this.peerConnection = null;
                    }
                    
                    this.isConnected = false;
                    this.isAudioPlaying = false;
                    
                    this.updateStatus('Mencoba reconnect...', 'bg-blue-100 text-blue-700', 'fa-sync-alt fa-spin');
                    
                    // Re-join room
                    this.socket.emit('join-room', {
                        roomId: this.roomCode,
                        username: this.listenerName
                    });
                },
                
                sendMessage() {
                    if (!this.chatMessage.trim()) return;
                    
                    this.socket.emit('send-message', {
                        roomId: this.roomCode,
                        message: this.chatMessage,
                        sender: this.listenerName
                    });
                    
                    this.chatMessage = '';
                },
                
                leaveRoom() {
                    if (this.peerConnection) {
                        this.peerConnection.close();
                    }
                    
                    window.location.href = '/';
                },
                
                updateStatus(message, className = 'bg-blue-100 text-blue-700', icon = 'fa-info-circle') {
                    this.statusMessage = message;
                    this.statusClass = className;
                    this.statusIcon = icon;
                }
            }
        }
    </script>
</body>
</html>