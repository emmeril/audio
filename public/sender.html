<!DOCTYPE html>
<html lang="id" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioStream - Host Room</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-purple {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .status-online { color: #10b981; }
        .status-offline { color: #ef4444; }
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="h-full gradient-purple">
    <div x-data="senderApp()" x-init="init()" class="min-h-screen">
        <!-- Top Navigation -->
        <nav class="bg-white/10 backdrop-blur-sm border-b border-white/20">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-3">
                        <a href="/" class="text-white hover:text-white/80">
                            <i class="fas fa-arrow-left"></i>
                        </a>
                        <div>
                            <h1 class="text-xl font-bold text-white">Host Room</h1>
                            <p class="text-white/80 text-sm" x-text="roomCode"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 rounded-full" :class="isStreaming ? 'bg-green-500 pulse-animation' : 'bg-red-500'"></div>
                            <span class="text-white text-sm" x-text="isStreaming ? 'Live' : 'Offline'"></span>
                        </div>
                        <button @click="copyRoomLink()" 
                                class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-share mr-2"></i>Share
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container mx-auto px-4 py-8">
            <div class="grid lg:grid-cols-3 gap-8">
                <!-- Left Column - Controls -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- Streaming Card -->
                    <div class="card-glass rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">
                                    <i class="fas fa-broadcast-tower mr-3"></i>
                                    Kontrol Streaming
                                </h2>
                                <p class="text-gray-600 mt-1" x-text="statusMessage"></p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-600">Listeners Online</p>
                                <p class="text-3xl font-bold text-purple-600" x-text="listeners.length"></p>
                            </div>
                        </div>

                        <!-- Room Info -->
                        <div class="mb-6 p-4 bg-purple-50 rounded-xl">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-purple-600 mb-1">Room Code:</p>
                                    <p class="text-2xl font-bold text-purple-800 font-mono" x-text="roomCode"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-purple-600 mb-1">Host:</p>
                                    <p class="text-xl font-semibold text-purple-800" x-text="hostName"></p>
                                </div>
                            </div>
                            <div class="mt-4 flex space-x-2">
                                <button @click="copyRoomCode()"
                                        class="flex-1 bg-purple-100 text-purple-700 px-4 py-2 rounded-lg hover:bg-purple-200">
                                    <i class="fas fa-copy mr-2"></i>Copy Code
                                </button>
                                <button @click="copyInviteLink()"
                                        class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                                    <i class="fas fa-link mr-2"></i>Copy Link
                                </button>
                            </div>
                        </div>

                        <!-- Streaming Controls -->
                        <div class="space-y-4">
                            <button @click="toggleStreaming()"
                                    :disabled="isStartingStream"
                                    :class="isStreaming ? 
                                            'bg-red-600 hover:bg-red-700' : 
                                            'bg-green-600 hover:bg-green-700'"
                                    class="w-full text-white font-bold py-4 px-6 rounded-xl text-lg flex items-center justify-center">
                                <i class="fas" :class="isStreaming ? 'fa-stop' : 'fa-play'" class="mr-3"></i>
                                <span x-text="isStreaming ? 'Stop Streaming' : 'Start Streaming'"></span>
                                <span x-show="isStartingStream" class="ml-3">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </span>
                            </button>

                            <div class="grid grid-cols-2 gap-4">
                                <button @click="refreshListeners()"
                                        class="bg-blue-100 text-blue-700 px-4 py-3 rounded-lg hover:bg-blue-200">
                                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                                </button>
                                <button @click="leaveRoom()"
                                        class="bg-gray-100 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-200">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Leave Room
                                </button>
                            </div>
                        </div>

                        <!-- Instructions -->
                        <div class="mt-8 p-4 bg-yellow-50 rounded-xl border border-yellow-200">
                            <h4 class="font-bold text-yellow-800 mb-2 flex items-center">
                                <i class="fas fa-info-circle mr-2"></i>
                                Panduan Streaming:
                            </h4>
                            <ol class="text-yellow-700 text-sm space-y-2">
                                <li class="flex items-start">
                                    <span class="font-bold mr-2">1.</span>
                                    <span>Buka <a href="https://music.youtube.com" target="_blank" class="underline font-semibold">YouTube Music</a> di tab baru</span>
                                </li>
                                <li class="flex items-start">
                                    <span class="font-bold mr-2">2.</span>
                                    <span>Play lagu yang ingin di-streaming</span>
                                </li>
                                <li class="flex items-start">
                                    <span class="font-bold mr-2">3.</span>
                                    <span>Klik "Start Streaming" di atas</span>
                                </li>
                                <li class="flex items-start">
                                    <span class="font-bold mr-2">4.</span>
                                    <span>Pilih tab YouTube Music dan centang "Share audio"</span>
                                </li>
                            </ol>
                        </div>
                    </div>

                    <!-- Preview Section -->
                    <div class="card-glass rounded-2xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-eye mr-3"></i>
                            Preview Streaming
                        </h3>
                        
                        <div class="aspect-video bg-black rounded-xl overflow-hidden mb-4">
                            <video x-ref="previewVideo" 
                                   autoplay 
                                   muted
                                   playsinline
                                   class="w-full h-full object-contain">
                                Your browser doesn't support video preview
                            </video>
                        </div>
                        
                        <div class="flex items-center justify-between text-sm text-gray-600">
                            <div>
                                <i class="fas fa-volume-up mr-2"></i>
                                <span>Audio: <span x-text="hasAudio ? 'Aktif' : 'Tidak Aktif'"></span></span>
                            </div>
                            <div>
                                <i class="fas fa-video mr-2"></i>
                                <span>Video: <span x-text="hasVideo ? 'Aktif' : 'Tidak Aktif'"></span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Listeners & Chat -->
                <div class="space-y-8">
                    <!-- Listeners List -->
                    <div class="card-glass rounded-2xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-users mr-3"></i>
                            Pendengar Online
                            <span class="ml-2 bg-purple-100 text-purple-800 text-sm px-2 py-1 rounded-full" 
                                  x-text="listeners.length"></span>
                        </h3>
                        
                        <div class="space-y-3 max-h-96 overflow-y-auto">
                            <template x-for="listener in listeners" :key="listener.id">
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div class="flex items-center">
                                        <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center mr-3">
                                            <i class="fas fa-user text-purple-600"></i>
                                        </div>
                                        <div>
                                            <p class="font-semibold text-gray-800" x-text="listener.name"></p>
                                            <p class="text-xs text-gray-500" x-text="formatTime(listener.joinedAt)"></p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                        <span class="text-xs text-gray-500">Online</span>
                                    </div>
                                </div>
                            </template>
                            
                            <div x-show="listeners.length === 0" 
                                 class="text-center py-8 text-gray-500">
                                <i class="fas fa-user-slash text-4xl mb-3"></i>
                                <p>Belum ada pendengar</p>
                                <p class="text-sm mt-1">Bagikan kode room untuk mengundang</p>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Box -->
                    <div class="card-glass rounded-2xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-comments mr-3"></i>
                            Chat Room
                        </h3>
                        
                        <div class="space-y-4">
                            <!-- Chat Messages -->
                            <div class="h-64 overflow-y-auto space-y-3 p-2">
                                <template x-for="message in messages" :key="message.timestamp">
                                    <div :class="message.isHost ? 'bg-blue-50' : 'bg-gray-50'"
                                         class="p-3 rounded-lg">
                                        <div class="flex justify-between items-start mb-1">
                                            <span class="font-semibold" 
                                                  :class="message.isHost ? 'text-blue-700' : 'text-gray-700'"
                                                  x-text="message.sender">
                                            </span>
                                            <span class="text-xs text-gray-500" x-text="message.timestamp"></span>
                                        </div>
                                        <p class="text-gray-800" x-text="message.message"></p>
                                    </div>
                                </template>
                                
                                <div x-show="messages.length === 0" 
                                     class="text-center py-8 text-gray-500">
                                    <i class="fas fa-comment-slash text-3xl mb-3"></i>
                                    <p>Belum ada pesan</p>
                                </div>
                            </div>
                            
                            <!-- Chat Input -->
                            <div class="flex space-x-2">
                                <input x-model="chatMessage" 
                                       @keyup.enter="sendMessage()"
                                       type="text" 
                                       placeholder="Ketik pesan..."
                                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <button @click="sendMessage()"
                                        class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="card-glass rounded-2xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">ðŸ“Š Statistik</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center p-3 bg-blue-50 rounded-lg">
                                <p class="text-2xl font-bold text-blue-700" x-text="totalListenersToday"></p>
                                <p class="text-sm text-blue-600">Total Pendengar</p>
                            </div>
                            <div class="text-center p-3 bg-green-50 rounded-lg">
                                <p class="text-2xl font-bold text-green-700" x-text="streamingTime"></p>
                                <p class="text-sm text-green-600">Durasi Streaming</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function senderApp() {
            return {
                socket: null,
                stream: null,
                peerConnections: new Map(),
                roomCode: '',
                hostName: '',
                isStreaming: false,
                isStartingStream: false,
                listeners: [],
                messages: [],
                chatMessage: '',
                hasAudio: false,
                hasVideo: false,
                totalListenersToday: 0,
                streamingTime: '0m',
                streamingStartTime: null,
                statusMessage: 'Siap untuk memulai streaming',
                
                async init() {
                    // Get URL parameters
                    const urlParams = new URLSearchParams(window.location.search);
                    this.roomCode = urlParams.get('room');
                    this.hostName = decodeURIComponent(urlParams.get('name') || 'Host');
                    
                    if (!this.roomCode) {
                        alert('Room tidak valid. Kembali ke halaman utama.');
                        window.location.href = '/';
                        return;
                    }
                    
                    // Connect to socket
                    this.socket = io();
                    
                    // Join room as host
                    this.socket.emit('create-room', {
                        roomId: this.roomCode,
                        username: this.hostName
                    });
                    
                    // Socket event listeners
                    this.socket.on('room-created', () => {
                        console.log('Room created successfully');
                        this.statusMessage = `Room ${this.roomCode} aktif. Bagikan kode ini.`;
                    });
                    
                    this.socket.on('listener-joined', (data) => {
                        console.log('New listener joined:', data);
                        this.listeners.push({
                            id: data.listenerId,
                            name: data.listenerName,
                            joinedAt: new Date()
                        });
                        this.totalListenersToday++;
                        
                        // Send welcome message
                        this.socket.emit('send-message', {
                            roomId: this.roomCode,
                            message: `${data.listenerName} telah bergabung ke room!`,
                            sender: 'System'
                        });
                    });
                    
                    this.socket.on('listener-left', (data) => {
                        this.listeners = this.listeners.filter(l => l.id !== data.listenerId);
                    });
                    
                    this.socket.on('new-message', (message) => {
                        this.messages.push(message);
                        // Auto scroll to bottom
                        setTimeout(() => {
                            const chatContainer = document.querySelector('[x-ref="chatContainer"]');
                            if (chatContainer) {
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            }
                        }, 100);
                    });
                    
                    this.socket.on('webrtc-answer', async (data) => {
                        const pc = this.peerConnections.get(data.from);
                        if (pc) {
                            await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                        }
                    });
                    
                    this.socket.on('ice-candidate', async (data) => {
                        const pc = this.peerConnections.get(data.from);
                        if (pc && data.candidate) {
                            await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                        }
                    });
                    
                    // Update streaming time every minute
                    setInterval(() => {
                        if (this.streamingStartTime) {
                            const diff = Date.now() - this.streamingStartTime;
                            const minutes = Math.floor(diff / 60000);
                            this.streamingTime = `${minutes}m`;
                        }
                    }, 60000);
                    
                    // Request room info
                    this.socket.emit('get-room-info', this.roomCode);
                },
                
                async toggleStreaming() {
                    if (this.isStreaming) {
                        await this.stopStreaming();
                    } else {
                        await this.startStreaming();
                    }
                },
                
                async startStreaming() {
                    try {
                        this.isStartingStream = true;
                        this.statusMessage = 'Meminta izin screen sharing...';
                        
                        // Request screen sharing with audio
                        const constraints = {
                            video: {
                                cursor: "always"
                            },
                            audio: {
                                echoCancellation: true,
                                noiseSuppression: true,
                                sampleRate: 44100
                            }
                        };
                        
                        // Try to get display media
                        this.stream = await navigator.mediaDevices.getDisplayMedia(constraints);
                        
                        // Check if audio is being captured
                        const audioTracks = this.stream.getAudioTracks();
                        this.hasAudio = audioTracks.length > 0;
                        this.hasVideo = this.stream.getVideoTracks().length > 0;
                        
                        if (!this.hasAudio) {
                            alert('âš ï¸ Audio tidak terdeteksi. Pastikan Anda mencentang "Share audio" saat memilih tab/window.');
                        }
                        
                        // Show preview
                        this.$refs.previewVideo.srcObject = this.stream;
                        
                        // Update status
                        this.isStreaming = true;
                        this.isStartingStream = false;
                        this.streamingStartTime = Date.now();
                        this.statusMessage = 'Streaming aktif! Audio sedang dikirim ke pendengar.';
                        
                        // Notify server
                        this.socket.emit('start-streaming', this.roomCode);
                        
                        // Create peer connections for existing listeners
                        this.createPeerConnections();
                        
                        // Handle track ended (user stops sharing)
                        this.stream.getVideoTracks()[0].onended = () => {
                            this.stopStreaming();
                        };
                        
                    } catch (error) {
                        console.error('Error starting stream:', error);
                        this.isStartingStream = false;
                        this.statusMessage = 'Gagal memulai streaming: ' + error.message;
                        
                        if (error.name === 'NotAllowedError') {
                            alert('Izin screen sharing ditolak. Harap izinkan akses screen sharing.');
                        }
                    }
                },
                
                async createPeerConnections() {
                    const configuration = {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun2.l.google.com:19302' }
                        ]
                    };
                    
                    for (const listener of this.listeners) {
                        const pc = new RTCPeerConnection(configuration);
                        
                        // Add stream tracks
                        this.stream.getTracks().forEach(track => {
                            pc.addTrack(track, this.stream);
                        });
                        
                        // Handle ICE candidates
                        pc.onicecandidate = (event) => {
                            if (event.candidate) {
                                this.socket.emit('ice-candidate', {
                                    to: listener.id,
                                    candidate: event.candidate,
                                    roomId: this.roomCode
                                });
                            }
                        };
                        
                        // Create and send offer
                        try {
                            const offer = await pc.createOffer({
                                offerToReceiveAudio: false,
                                offerToReceiveVideo: false
                            });
                            
                            await pc.setLocalDescription(offer);
                            
                            this.socket.emit('webrtc-offer', {
                                to: listener.id,
                                offer: offer,
                                roomId: this.roomCode
                            });
                            
                            this.peerConnections.set(listener.id, pc);
                            
                        } catch (error) {
                            console.error('Error creating peer connection:', error);
                        }
                    }
                },
                
                async stopStreaming() {
                    if (this.stream) {
                        // Stop all tracks
                        this.stream.getTracks().forEach(track => {
                            track.stop();
                        });
                        this.stream = null;
                    }
                    
                    // Clear preview
                    this.$refs.previewVideo.srcObject = null;
                    
                    // Close all peer connections
                    this.peerConnections.forEach(pc => pc.close());
                    this.peerConnections.clear();
                    
                    // Update status
                    this.isStreaming = false;
                    this.hasAudio = false;
                    this.hasVideo = false;
                    this.statusMessage = 'Streaming dihentikan. Klik "Start Streaming" untuk mulai lagi.';
                    
                    // Notify server
                    this.socket.emit('stop-streaming', this.roomCode);
                },
                
                copyRoomCode() {
                    navigator.clipboard.writeText(this.roomCode);
                    alert(`Kode room "${this.roomCode}" disalin!`);
                },
                
                copyInviteLink() {
                    const link = `${window.location.origin}/receiver?room=${this.roomCode}`;
                    navigator.clipboard.writeText(link);
                    alert('Link undangan disalin!');
                },
                
                copyRoomLink() {
                    this.copyInviteLink();
                },
                
                sendMessage() {
                    if (!this.chatMessage.trim()) return;
                    
                    this.socket.emit('send-message', {
                        roomId: this.roomCode,
                        message: this.chatMessage,
                        sender: this.hostName
                    });
                    
                    this.chatMessage = '';
                },
                
                refreshListeners() {
                    this.socket.emit('get-room-info', this.roomCode);
                },
                
                leaveRoom() {
                    if (confirm('Apakah Anda yakin ingin meninggalkan room? Semua pendengar akan terputus.')) {
                        this.stopStreaming();
                        window.location.href = '/';
                    }
                },
                
                formatTime(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
            }
        }
    </script>
</body>
</html>