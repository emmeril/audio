<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Stream - Pengirim</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/debug.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .audio-wave {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 60px;
        }
        
        .audio-bar {
            width: 4px;
            margin: 0 2px;
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 2px;
            animation: audioWave 1.5s ease-in-out infinite;
        }
        
        .audio-bar:nth-child(2) { animation-delay: 0.1s; height: 40px; }
        .audio-bar:nth-child(3) { animation-delay: 0.2s; height: 50px; }
        .audio-bar:nth-child(4) { animation-delay: 0.3s; height: 60px; }
        .audio-bar:nth-child(5) { animation-delay: 0.4s; height: 50px; }
        .audio-bar:nth-child(6) { animation-delay: 0.5s; height: 40px; }
        
        @keyframes audioWave {
            0%, 100% { height: 20px; }
            50% { height: 60px; }
        }
        
        .video-preview {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .video-preview::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            z-index: 1;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div x-data="senderApp()" x-init="init()" class="min-h-screen">
        <!-- Header -->
        <header class="bg-white/10 backdrop-blur-sm border-b border-white/20">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <a href="/" class="flex items-center space-x-2 text-white hover:text-white/80 transition">
                            <span class="text-2xl">‚Üê</span>
                            <span>Kembali</span>
                        </a>
                        <div class="h-6 w-px bg-white/30"></div>
                        <div>
                            <h1 class="text-xl font-bold text-white">üé§ Mode Pengirim</h1>
                            <p class="text-white/80 text-sm">Streaming audio ke pendengar</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="glass-card px-4 py-2 rounded-lg">
                            <div class="flex items-center">
                                <div class="status-indicator" :class="isStreaming ? 'bg-green-400 animate-pulse' : 'bg-gray-400'"></div>
                                <span class="text-white text-sm" x-text="isStreaming ? 'Streaming Aktif' : 'Siap'"></span>
                            </div>
                        </div>
                        
                        <div class="glass-card px-4 py-2 rounded-lg">
                            <div class="text-white text-sm">
                                <span class="opacity-80">Pendengar:</span>
                                <span class="font-bold ml-2" x-text="listeners.size"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column - Controls -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- Room Card -->
                    <div class="bg-white rounded-2xl shadow-2xl p-6">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">Room Streaming</h2>
                                <p class="text-gray-600">Bagikan kode ini ke pendengar</p>
                            </div>
                            
                            <div class="flex items-center space-x-3">
                                <button @click="copyRoomCode()"
                                        class="bg-blue-100 text-blue-700 hover:bg-blue-200 px-4 py-2 rounded-lg transition flex items-center">
                                    <span class="mr-2">üìã</span>
                                    Salin
                                </button>
                                
                                <button @click="refreshRoom()"
                                        class="bg-gray-100 text-gray-700 hover:bg-gray-200 px-4 py-2 rounded-lg transition flex items-center">
                                    <span class="mr-2">üîÑ</span>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        
                        <!-- Room Code Display -->
                        <div class="mb-6">
                            <div class="text-center p-6 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl border-2 border-dashed border-blue-200">
                                <p class="text-sm text-gray-600 mb-2">Kode Room Anda</p>
                                <div class="text-5xl font-bold text-gray-800 tracking-wider mb-2" x-text="roomCode"></div>
                                <p class="text-sm text-gray-500">Berikan kode ini ke pendengar untuk bergabung</p>
                            </div>
                        </div>
                        
                        <!-- Connection Stats -->
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600">Status Koneksi</p>
                                        <p class="text-lg font-semibold text-gray-800">
                                            <span x-text="connectionStats.iceState || 'Waiting'"></span>
                                        </p>
                                    </div>
                                    <div class="text-2xl">üì°</div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600">Peer Connections</p>
                                        <p class="text-lg font-semibold text-gray-800" x-text="peerConnections.size"></p>
                                    </div>
                                    <div class="text-2xl">üîó</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Main Controls -->
                        <div class="space-y-4">
                            <button @click="startStreaming()"
                                    :disabled="isStreaming || isLoading"
                                    :class="isStreaming ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700'"
                                    class="w-full text-white font-semibold py-4 px-6 rounded-xl transition duration-200 flex items-center justify-center">
                                <template x-if="isLoading">
                                    <span class="flex items-center">
                                        <svg class="animate-spin h-5 w-5 mr-3 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        Memproses...
                                    </span>
                                </template>
                                <template x-if="!isLoading">
                                    <span class="flex items-center">
                                        <span class="mr-3 text-xl" x-text="isStreaming ? 'üî¥' : '‚ñ∂Ô∏è'"></span>
                                        <span x-text="isStreaming ? 'Streaming Sedang Berjalan' : 'Mulai Streaming'"></span>
                                    </span>
                                </template>
                            </button>
                            
                            <button @click="stopStreaming()"
                                    :disabled="!isStreaming"
                                    :class="isStreaming ? 'bg-red-600 hover:bg-red-700' : 'bg-gray-400 cursor-not-allowed'"
                                    class="w-full text-white font-semibold py-4 px-6 rounded-xl transition duration-200">
                                ‚èπÔ∏è Berhenti Streaming
                            </button>
                        </div>
                    </div>

                    <!-- Audio Preview -->
                    <div class="bg-white rounded-2xl shadow-2xl p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">üëÅÔ∏è Preview Streaming</h2>
                        
                        <div class="video-preview aspect-video mb-4">
                            <video x-ref="previewVideo" 
                                   autoplay 
                                   muted
                                   playsinline
                                   class="w-full h-full object-contain relative z-10">
                                Your browser does not support the video tag.
                            </video>
                            
                            <div class="absolute inset-0 flex items-center justify-center z-0" x-show="!isStreaming">
                                <div class="text-center p-8">
                                    <div class="text-6xl mb-4 opacity-30">üéµ</div>
                                    <p class="text-white text-lg font-semibold">Preview akan muncul disini</p>
                                    <p class="text-white/70">Mulai streaming untuk melihat preview</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Audio Visualization -->
                        <div class="mt-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-gray-700 font-medium">Audio Level</span>
                                <span class="text-gray-500 text-sm" x-text="audioLevel + '%'"></span>
                            </div>
                            <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full transition-all duration-300"
                                     :style="`width: ${audioLevel}%`"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Listeners & Info -->
                <div class="space-y-8">
                    <!-- Connected Listeners -->
                    <div class="bg-white rounded-2xl shadow-2xl p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            <span class="mr-3">üë•</span>
                            Pendengar Terhubung
                            <span class="ml-2 bg-blue-100 text-blue-700 text-sm font-semibold px-3 py-1 rounded-full" 
                                  x-text="listeners.size"></span>
                        </h2>
                        
                        <div class="space-y-3 max-h-96 overflow-y-auto pr-2" x-ref="listenersContainer">
                            <!-- Listeners will be added here dynamically -->
                            <template x-for="listenerId in Array.from(listeners)" :key="listenerId">
                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition">
                                    <div class="flex items-center">
                                        <div class="w-3 h-3 bg-green-500 rounded-full mr-3 animate-pulse"></div>
                                        <div>
                                            <p class="font-semibold text-gray-800" x-text="'Pendengar ' + listenerId.substring(0, 8)"></p>
                                            <p class="text-xs text-gray-500" x-text="getConnectionStatus(listenerId)"></p>
                                        </div>
                                    </div>
                                    <div class="text-gray-400">
                                        <div class="audio-wave">
                                            <div class="audio-bar"></div>
                                            <div class="audio-bar"></div>
                                            <div class="audio-bar"></div>
                                            <div class="audio-bar"></div>
                                            <div class="audio-bar"></div>
                                            <div class="audio-bar"></div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            
                            <div class="text-center p-8" x-show="listeners.size === 0">
                                <div class="text-4xl mb-4 text-gray-300">üëÇ</div>
                                <p class="text-gray-500 font-medium">Belum ada pendengar</p>
                                <p class="text-gray-400 text-sm mt-1">Bagikan kode room untuk mengundang pendengar</p>
                            </div>
                        </div>
                        
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <div class="text-sm text-gray-600">
                                <p class="mb-1">üí° <span class="font-medium">Tips:</span> Refresh halaman jika koneksi bermasalah</p>
                                <p>üéØ Pendengar akan terhubung otomatis saat bergabung</p>
                            </div>
                        </div>
                    </div>

                    <!-- Technical Info -->
                    <div class="bg-white rounded-2xl shadow-2xl p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">‚öôÔ∏è Informasi Teknis</h2>
                        
                        <div class="space-y-4">
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="text-gray-700">Status ICE</span>
                                <span class="font-semibold" :class="{
                                    'text-green-600': connectionStats.iceState === 'connected',
                                    'text-yellow-600': connectionStats.iceState === 'checking',
                                    'text-red-600': connectionStats.iceState === 'failed'
                                }" x-text="connectionStats.iceState || 'idle'"></span>
                            </div>
                            
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="text-gray-700">Signal Status</span>
                                <span class="font-semibold" :class="{
                                    'text-green-600': connectionStats.signalingState === 'stable',
                                    'text-yellow-600': connectionStats.signalingState === 'have-local-offer',
                                    'text-red-600': connectionStats.signalingState === 'closed'
                                }" x-text="connectionStats.signalingState || 'idle'"></span>
                            </div>
                            
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="text-gray-700">Audio Tracks</span>
                                <span class="font-semibold text-blue-600" x-text="audioTracksCount"></span>
                            </div>
                            
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="text-gray-700">Socket Status</span>
                                <span class="font-semibold" :class="socketConnected ? 'text-green-600' : 'text-red-600'"
                                      x-text="socketConnected ? 'Connected' : 'Disconnected'"></span>
                            </div>
                        </div>
                        
                        <!-- Debug Controls -->
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <h3 class="font-semibold text-gray-700 mb-3">Debug Tools</h3>
                            <div class="flex space-x-2">
                                <button @click="forceReconnectAll()"
                                        class="flex-1 bg-yellow-100 text-yellow-700 hover:bg-yellow-200 py-2 px-3 rounded-lg text-sm">
                                    üîÑ Reconnect All
                                </button>
                                <button @click="logDebugInfo()"
                                        class="flex-1 bg-gray-100 text-gray-700 hover:bg-gray-200 py-2 px-3 rounded-lg text-sm">
                                    üìä Log Info
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Status Bar -->
        <div class="fixed bottom-0 left-0 right-0 bg-black/80 backdrop-blur-sm text-white py-3 px-4">
            <div class="container mx-auto">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <div class="status-indicator" :class="statusColor"></div>
                            <span x-text="statusMessage"></span>
                        </div>
                        <div class="text-sm opacity-75" x-text="statusDetail"></div>
                    </div>
                    <div class="text-sm opacity-75">
                        Server: <span x-text="socketConnected ? 'Online' : 'Offline'"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function senderApp() {
            return {
                // State
                socket: null,
                roomCode: '',
                isStreaming: false,
                isLoading: false,
                peerConnections: new Map(),
                listeners: new Set(),
                stream: null,
                socketConnected: false,
                
                // Status
                statusMessage: 'Menyiapkan aplikasi...',
                statusDetail: 'Menghubungkan ke server...',
                statusColor: 'bg-yellow-500',
                
                // Stats
                connectionStats: {
                    iceState: '',
                    signalingState: '',
                    gatheringState: ''
                },
                audioTracksCount: 0,
                audioLevel: 20,
                
                // Initialization
                async init() {
                    console.log('üöÄ Initializing sender application...');
                    
                    // Get room code from URL or generate
                    const urlParams = new URLSearchParams(window.location.search);
                    let roomParam = urlParams.get('room');
                    
                    if (roomParam) {
                        this.roomCode = roomParam.toUpperCase();
                    } else {
                        // Generate readable room code
                        this.roomCode = this.generateRoomCode();
                        // Update URL without reload
                        window.history.replaceState({}, '', `/sender?room=${this.roomCode}`);
                    }
                    
                    this.updateStatus(`Room: ${this.roomCode}`, 'bg-blue-500', 'Menghubungkan ke server...');
                    
                    // Initialize socket connection
                    await this.initializeSocket();
                    
                    // Update status
                    this.updateStatus(`Siap streaming ke room ${this.roomCode}`, 'bg-green-500', 'Klik "Mulai Streaming" untuk memulai');
                    
                    // Start audio level simulation
                    this.startAudioLevelSimulation();
                },
                
                // Socket initialization
                async initializeSocket() {
                    try {
                        this.socket = io({
                            transports: ['websocket', 'polling'],
                            reconnectionAttempts: 5,
                            reconnectionDelay: 1000
                        });
                        
                        // Connection events
                        this.socket.on('connect', () => {
                            console.log('‚úÖ Socket connected:', this.socket.id);
                            this.socketConnected = true;
                            this.updateStatus(`Terhubung ke server`, 'bg-green-500', `Socket ID: ${this.socket.id.substring(0, 8)}...`);
                            
                            // Join room as host
                            this.socket.emit('join-room', this.roomCode, 'host');
                        });
                        
                        this.socket.on('room-joined', (data) => {
                            console.log('üéâ Room joined:', data);
                            this.updateStatus(`Room ${this.roomCode} aktif`, 'bg-green-500', 'Siap menerima pendengar');
                        });
                        
                        // New listener joined
                        this.socket.on('new-listener', (data) => {
                            console.log('üëÇ New listener:', data.listenerId);
                            this.listeners.add(data.listenerId);
                            this.updateStatus(`Pendengar baru bergabung`, 'bg-blue-500', `ID: ${data.listenerId.substring(0, 8)}...`);
                            
                            // If already streaming, create connection
                            if (this.isStreaming && this.stream) {
                                this.createPeerConnection(data.listenerId);
                            }
                        });
                        
                        // Listener left
                        this.socket.on('listener-left', (data) => {
                            console.log('üëã Listener left:', data.listenerId);
                            this.listeners.delete(data.listenerId);
                            
                            // Close peer connection
                            const pc = this.peerConnections.get(data.listenerId);
                            if (pc) {
                                pc.close();
                                this.peerConnections.delete(data.listenerId);
                            }
                            
                            this.updateStatus(`Pendengar keluar`, 'bg-yellow-500', `ID: ${data.listenerId.substring(0, 8)}...`);
                        });
                        
                        // Connection requested by listener
                        this.socket.on('connection-requested', async (data) => {
                            console.log('üîó Connection requested by:', data.listenerId);
                            this.listeners.add(data.listenerId);
                            
                            if (this.isStreaming && this.stream) {
                                await this.createPeerConnection(data.listenerId);
                            }
                        });
                        
                        // Handle SDP answers
                        this.socket.on('sdp-answer', async (data) => {
                            try {
                                const answer = new RTCSessionDescription(data.answer);
                                const pc = this.peerConnections.get(this.socket.id);
                                if (pc && pc.signalingState !== 'closed') {
                                    await pc.setRemoteDescription(answer);
                                    console.log('‚úÖ Remote description set');
                                }
                            } catch (error) {
                                console.error('‚ùå Error setting remote description:', error);
                            }
                        });
                        
                        // Handle ICE candidates
                        this.socket.on('ice-candidate', async (data) => {
                            try {
                                const pc = this.peerConnections.get(this.socket.id);
                                if (pc && data.candidate && pc.remoteDescription) {
                                    await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                                    console.log('‚úÖ ICE candidate added');
                                }
                            } catch (error) {
                                console.error('‚ùå Error adding ICE candidate:', error);
                            }
                        });
                        
                        // Socket errors
                        this.socket.on('connect_error', (error) => {
                            console.error('‚ùå Socket connection error:', error);
                            this.socketConnected = false;
                            this.updateStatus('Koneksi server bermasalah', 'bg-red-500', 'Mencoba reconnect...');
                        });
                        
                        this.socket.on('disconnect', (reason) => {
                            console.log('‚ö†Ô∏è Socket disconnected:', reason);
                            this.socketConnected = false;
                            this.updateStatus('Terputus dari server', 'bg-red-500', 'Mencoba reconnect...');
                        });
                        
                        // Initial connection
                        this.socket.connect();
                        
                    } catch (error) {
                        console.error('‚ùå Error initializing socket:', error);
                        this.updateStatus('Gagal menghubungkan ke server', 'bg-red-500', 'Refresh halaman untuk mencoba lagi');
                    }
                },
                
                // Start streaming - DIPERBAIKI
                async startStreaming() {
                    if (this.isStreaming || this.isLoading) return;
                    
                    this.isLoading = true;
                    this.updateStatus('Menyiapkan streaming...', 'bg-blue-500', 'Meminta izin screen sharing...');
                    
                    try {
                        console.log('üé¨ Requesting screen share...');
                        
                        let stream;
                        const isChrome = navigator.userAgent.includes('Chrome');
                        
                        // Method 1: Coba dengan preferensi yang berbeda
                        try {
                            if (isChrome) {
                                // Chrome-specific dengan preferensi untuk audio tab
                                stream = await navigator.mediaDevices.getDisplayMedia({
                                    video: {
                                        displaySurface: 'browser',
                                        cursor: 'always'
                                    },
                                    audio: {
                                        echoCancellation: false,
                                        noiseSuppression: false,
                                        autoGainControl: false,
                                        sampleRate: 48000,
                                        channelCount: 2
                                    },
                                    systemAudio: 'include' // Chrome-specific
                                });
                            } else {
                                // Firefox dan browser lain
                                stream = await navigator.mediaDevices.getDisplayMedia({
                                    video: true,
                                    audio: true
                                });
                            }
                        } catch (error1) {
                            console.log('Method 1 failed:', error1);
                            
                            // Method 2: Coba tanpa spesifikasi
                            stream = await navigator.mediaDevices.getDisplayMedia({
                                video: true,
                                audio: true
                            });
                        }
                        
                        // Debug: Check what we got
                        console.log('‚úÖ Display stream obtained');
                        console.log('Video tracks:', stream.getVideoTracks().length);
                        console.log('Audio tracks:', stream.getAudioTracks().length);
                        
                        // Jika tidak ada audio track, coba tambahkan audio system
                        if (stream.getAudioTracks().length === 0) {
                            console.warn('‚ö†Ô∏è No audio tracks in display stream! Trying to add system audio...');
                            
                            try {
                                // Coba capture audio system secara terpisah
                                const audioConstraints = {
                                    audio: {
                                        mandatory: {
                                            chromeMediaSource: 'desktop',
                                            chromeMediaSourceId: stream.getVideoTracks()[0]?.getSettings()?.deviceId
                                        }
                                    },
                                    video: false
                                };
                                
                                let systemAudioStream;
                                if (isChrome) {
                                    systemAudioStream = await navigator.mediaDevices.getUserMedia(audioConstraints);
                                } else {
                                    // Fallback untuk browser lain
                                    systemAudioStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                                }
                                
                                if (systemAudioStream.getAudioTracks().length > 0) {
                                    systemAudioStream.getAudioTracks().forEach(track => {
                                        stream.addTrack(track);
                                        console.log('‚úÖ Added system audio track:', track);
                                    });
                                }
                            } catch (audioError) {
                                console.error('Failed to add system audio:', audioError);
                            }
                        }
                        
                        // Cek lagi setelah percobaan
                        const finalAudioTracks = stream.getAudioTracks();
                        if (finalAudioTracks.length === 0) {
                            // Coba terakhir: gunakan microphone sebagai fallback
                            try {
                                const micStream = await navigator.mediaDevices.getUserMedia({ 
                                    audio: {
                                        echoCancellation: false,
                                        noiseSuppression: false,
                                        autoGainControl: false
                                    }, 
                                    video: false 
                                });
                                
                                micStream.getAudioTracks().forEach(track => {
                                    stream.addTrack(track);
                                    console.log('‚úÖ Added microphone audio as fallback:', track);
                                });
                            } catch (micError) {
                                console.error('Microphone fallback failed:', micError);
                                throw new Error('Tidak mendapatkan audio. Pastikan centang "Share audio" saat screen sharing');
                            }
                        }
                        
                        // Log final track information
                        const audioTracks = stream.getAudioTracks();
                        this.audioTracksCount = audioTracks.length;
                        
                        audioTracks.forEach((track, index) => {
                            console.log(`Audio Track ${index}:`, {
                                enabled: track.enabled,
                                muted: track.muted,
                                readyState: track.readyState,
                                label: track.label,
                                kind: track.kind,
                                settings: track.getSettings()
                            });
                            
                            // Pastikan track diaktifkan
                            track.enabled = true;
                        });
                        
                        // Simpan stream
                        this.stream = stream;
                        
                        // Tampilkan preview
                        this.$refs.previewVideo.srcObject = this.stream;
                        this.isStreaming = true;
                        
                        // Notify server
                        this.socket.emit('host-started-streaming', this.roomCode);
                        
                        // Create peer connections for existing listeners
                        await this.createPeerConnectionsForAllListeners();
                        
                        this.updateStatus('Streaming aktif!', 'bg-green-500', 
                            `${audioTracks.length} audio track(s) aktif. Pendengar: ${this.listeners.size}`);
                        
                        // Start monitoring audio tracks
                        this.startAudioTrackMonitoring();
                        
                    } catch (error) {
                        console.error('‚ùå Error starting stream:', error);
                        
                        let errorMessage = 'Gagal memulai streaming';
                        if (error.name === 'NotAllowedError') {
                            errorMessage = 'Izin screen sharing ditolak';
                        } else if (error.name === 'NotFoundError') {
                            errorMessage = 'Tidak ada layar yang tersedia';
                        } else if (error.message.includes('Share audio')) {
                            errorMessage = 'Harap centang "Share audio" saat memilih layar';
                        }
                        
                        this.updateStatus(errorMessage, 'bg-red-500', error.message);
                        this.stopStreaming();
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                // Monitor audio tracks
                startAudioTrackMonitoring() {
                    if (!this.stream) return;
                    
                    const checkInterval = setInterval(() => {
                        if (!this.isStreaming || !this.stream) {
                            clearInterval(checkInterval);
                            return;
                        }
                        
                        const audioTracks = this.stream.getAudioTracks();
                        this.audioTracksCount = audioTracks.length;
                        
                        if (audioTracks.length === 0) {
                            console.warn('‚ö†Ô∏è Audio tracks lost!');
                            this.updateStatus('Audio track hilang', 'bg-yellow-500', 'Coba mulai ulang streaming');
                        }
                    }, 3000);
                },
                
                // Create peer connections for all listeners
                async createPeerConnectionsForAllListeners() {
                    if (!this.stream || !this.isStreaming) {
                        console.warn('Cannot create peer connections: No stream or not streaming');
                        return;
                    }
                    
                    for (const listenerId of this.listeners) {
                        await this.createPeerConnection(listenerId);
                    }
                },
                
                // Create peer connection for a specific listener - DIPERBAIKI
                async createPeerConnection(listenerId) {
                    try {
                        // Close existing connection if any
                        const existingPc = this.peerConnections.get(listenerId);
                        if (existingPc) {
                            existingPc.close();
                            this.peerConnections.delete(listenerId);
                        }
                        
                        const configuration = {
                            iceServers: [
                                { urls: 'stun:stun.l.google.com:19302' },
                                { urls: 'stun:stun1.l.google.com:19302' },
                                { urls: 'stun:stun2.l.google.com:19302' },
                                { urls: 'stun:stun3.l.google.com:19302' },
                                { urls: 'stun:stun4.l.google.com:19302' }
                            ],
                            iceTransportPolicy: 'all',
                            bundlePolicy: 'max-bundle',
                            rtcpMuxPolicy: 'require',
                            encodedInsertableStreams: false
                        };
                        
                        const pc = new RTCPeerConnection(configuration);
                        
                        // Tambahkan semua track dari stream
                        if (this.stream) {
                            this.stream.getTracks().forEach(track => {
                                console.log(`Adding ${track.kind} track to peer connection for ${listenerId.substring(0, 8)}`);
                                
                                // Pastikan track tidak di-duplicate
                                if (track.readyState === 'ended') {
                                    console.warn(`Track ${track.kind} sudah ended, mencari track baru...`);
                                    return;
                                }
                                
                                try {
                                    // Gunakan transceiver untuk kontrol yang lebih baik
                                    const transceiver = pc.addTransceiver(track, {
                                        direction: 'sendonly',
                                        streams: [this.stream]
                                    });
                                    
                                    console.log(`Transceiver created for ${track.kind}:`, transceiver);
                                } catch (addError) {
                                    console.error(`Error adding ${track.kind} track:`, addError);
                                }
                            });
                        } else {
                            console.error('No stream available when creating peer connection');
                            return;
                        }
                        
                        // ICE candidate handler
                        pc.onicecandidate = (event) => {
                            if (event.candidate && this.socket) {
                                this.socket.emit('ice-candidate', {
                                    roomId: this.roomCode,
                                    candidate: event.candidate,
                                    to: listenerId
                                });
                            }
                        };
                        
                        // ICE connection state change
                        pc.oniceconnectionstatechange = () => {
                            this.connectionStats.iceState = pc.iceConnectionState;
                            console.log(`ICE state for ${listenerId.substring(0, 8)}:`, pc.iceConnectionState);
                            
                            if (pc.iceConnectionState === 'connected' || 
                                pc.iceConnectionState === 'completed') {
                                console.log(`‚úÖ Connected to ${listenerId.substring(0, 8)}`);
                                this.updateStatus(`Terhubung dengan pendengar`, 'bg-green-500', 
                                    `ID: ${listenerId.substring(0, 8)}...`);
                                
                                // Log connection stats
                                this.logConnectionStats(pc, listenerId);
                            } else if (pc.iceConnectionState === 'failed' ||
                                     pc.iceConnectionState === 'disconnected') {
                                console.log(`‚ùå Connection issue with ${listenerId.substring(0, 8)}`);
                                
                                // Coba restart ICE
                                setTimeout(() => {
                                    if (pc.iceConnectionState === 'failed' || 
                                        pc.iceConnectionState === 'disconnected') {
                                        console.log(`Attempting ICE restart for ${listenerId.substring(0, 8)}`);
                                        this.restartIce(pc, listenerId);
                                    }
                                }, 2000);
                            } else if (pc.iceConnectionState === 'closed') {
                                console.log(`Connection closed for ${listenerId.substring(0, 8)}`);
                                this.peerConnections.delete(listenerId);
                            }
                        };
                        
                        // ICE gathering state
                        pc.onicegatheringstatechange = () => {
                            this.connectionStats.gatheringState = pc.iceGatheringState;
                        };
                        
                        // Signaling state change
                        pc.onsignalingstatechange = () => {
                            this.connectionStats.signalingState = pc.signalingState;
                        };
                        
                        // Track events
                        pc.ontrack = (event) => {
                            console.log('Track event received (should not happen for sender):', event);
                        };
                        
                        // Connection state
                        pc.onconnectionstatechange = () => {
                            console.log(`Connection state for ${listenerId}:`, pc.connectionState);
                        };
                        
                        // Create and send offer dengan preferensi audio yang jelas
                        try {
                            const offer = await pc.createOffer({
                                offerToReceiveAudio: false,
                                offerToReceiveVideo: false,
                                iceRestart: false
                            });
                            
                            await pc.setLocalDescription(offer);
                            
                            // Kirim offer ke listener
                            if (this.socket) {
                                this.socket.emit('sdp-offer', {
                                    roomId: this.roomCode,
                                    offer: offer,
                                    to: listenerId
                                });
                                
                                console.log(`‚úÖ SDP offer sent to ${listenerId.substring(0, 8)}`);
                            }
                        } catch (offerError) {
                            console.error(`Error creating offer for ${listenerId}:`, offerError);
                        }
                        
                        // Store connection
                        this.peerConnections.set(listenerId, pc);
                        
                        console.log(`‚úÖ Created peer connection for ${listenerId.substring(0, 8)}`);
                        
                    } catch (error) {
                        console.error(`‚ùå Error creating peer connection for ${listenerId}:`, error);
                        this.updateStatus(`Gagal membuat koneksi ke pendengar`, 'bg-red-500', error.message);
                    }
                },
                
                // Helper: Restart ICE
                async restartIce(pc, listenerId) {
                    try {
                        const restartOffer = await pc.createOffer({ iceRestart: true });
                        await pc.setLocalDescription(restartOffer);
                        
                        if (this.socket) {
                            this.socket.emit('sdp-offer', {
                                roomId: this.roomCode,
                                offer: restartOffer,
                                to: listenerId
                            });
                            console.log(`ICE restart offer sent to ${listenerId}`);
                        }
                    } catch (error) {
                        console.error(`ICE restart failed for ${listenerId}:`, error);
                    }
                },
                
                // Helper: Log connection stats
                async logConnectionStats(pc, listenerId) {
                    try {
                        const stats = await pc.getStats();
                        let audioStats = null;
                        
                        stats.forEach(report => {
                            if (report.type === 'outbound-rtp' && report.kind === 'audio') {
                                audioStats = report;
                            }
                        });
                        
                        if (audioStats) {
                            console.log(`Audio stats for ${listenerId}:`, {
                                bytesSent: audioStats.bytesSent,
                                packetsSent: audioStats.packetsSent,
                                timestamp: audioStats.timestamp
                            });
                        }
                    } catch (error) {
                        console.error('Error getting stats:', error);
                    }
                },
                
                // Stop streaming
                stopStreaming() {
                    if (this.stream) {
                        this.stream.getTracks().forEach(track => {
                            track.stop();
                            console.log(`Stopped ${track.kind} track`);
                        });
                        this.stream = null;
                        this.$refs.previewVideo.srcObject = null;
                    }
                    
                    // Close all peer connections
                    this.peerConnections.forEach((pc, listenerId) => {
                        pc.close();
                        console.log(`Closed peer connection for ${listenerId}`);
                    });
                    this.peerConnections.clear();
                    
                    this.isStreaming = false;
                    this.audioTracksCount = 0;
                    
                    // Notify server
                    if (this.socket) {
                        this.socket.emit('host-stopped-streaming', this.roomCode);
                    }
                    
                    this.updateStatus('Streaming dihentikan', 'bg-gray-500', 'Klik "Mulai Streaming" untuk mulai lagi');
                },
                
                // Helper methods
                generateRoomCode() {
                    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                    let code = '';
                    for (let i = 0; i < 6; i++) {
                        code += chars.charAt(Math.floor(Math.random() * chars.length));
                    }
                    return code;
                },
                
                copyRoomCode() {
                    navigator.clipboard.writeText(this.roomCode)
                        .then(() => {
                            this.showNotification('Kode room disalin!', 'success');
                        })
                        .catch(err => {
                            console.error('Failed to copy:', err);
                            this.showNotification('Gagal menyalin kode', 'error');
                        });
                },
                
                refreshRoom() {
                    window.location.reload();
                },
                
                getConnectionStatus(listenerId) {
                    const pc = this.peerConnections.get(listenerId);
                    if (!pc) return 'Menunggu koneksi...';
                    
                    switch(pc.iceConnectionState) {
                        case 'new': return 'Menyiapkan...';
                        case 'checking': return 'Mengecek koneksi...';
                        case 'connected': return 'Terhubung';
                        case 'completed': return 'Selesai';
                        case 'disconnected': return 'Terputus';
                        case 'failed': return 'Gagal';
                        case 'closed': return 'Ditutup';
                        default: return 'Unknown';
                    }
                },
                
                forceReconnectAll() {
                    this.updateStatus('Memulai ulang koneksi...', 'bg-yellow-500');
                    
                    // Close all existing connections
                    this.peerConnections.forEach(pc => pc.close());
                    this.peerConnections.clear();
                    
                    // Create new connections
                    if (this.isStreaming && this.stream) {
                        this.createPeerConnectionsForAllListeners();
                    }
                },
                
                logDebugInfo() {
                    console.group('üîç Debug Info');
                    console.log('Room Code:', this.roomCode);
                    console.log('Is Streaming:', this.isStreaming);
                    console.log('Socket Connected:', this.socketConnected);
                    console.log('Listeners:', Array.from(this.listeners));
                    console.log('Peer Connections:', this.peerConnections.size);
                    console.log('Audio Tracks:', this.audioTracksCount);
                    console.log('Stream:', this.stream);
                    
                    if (this.stream) {
                        console.log('Stream Tracks:', this.stream.getTracks().map(t => ({
                            kind: t.kind,
                            enabled: t.enabled,
                            muted: t.muted,
                            readyState: t.readyState,
                            label: t.label
                        })));
                    }
                    
                    console.groupEnd();
                    
                    this.showNotification('Info debug dicetak ke console', 'info');
                },
                
                startAudioLevelSimulation() {
                    setInterval(() => {
                        if (this.isStreaming && this.audioTracksCount > 0) {
                            // Simulate audio level changes
                            this.audioLevel = 20 + Math.random() * 60;
                        } else {
                            this.audioLevel = 20;
                        }
                    }, 200);
                },
                
                updateStatus(message, color = 'bg-blue-500', detail = '') {
                    this.statusMessage = message;
                    this.statusColor = color;
                    this.statusDetail = detail;
                },
                
                showNotification(message, type = 'info') {
                    // Simple notification
                    const alertDiv = document.createElement('div');
                    alertDiv.className = `fixed top-4 right-4 px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300 z-50 ${
                        type === 'error' ? 'bg-red-500 text-white' :
                        type === 'success' ? 'bg-green-500 text-white' :
                        'bg-blue-500 text-white'
                    }`;
                    alertDiv.innerHTML = `
                        <div class="flex items-center">
                            <span class="mr-3">${type === 'error' ? '‚ö†Ô∏è' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}</span>
                            <span>${message}</span>
                        </div>
                    `;
                    
                    document.body.appendChild(alertDiv);
                    
                    setTimeout(() => {
                        alertDiv.style.transform = 'translateX(100%)';
                        alertDiv.style.opacity = '0';
                        setTimeout(() => {
                            if (alertDiv.parentNode) {
                                document.body.removeChild(alertDiv);
                            }
                        }, 300);
                    }, 3000);
                }
            };
        }
    </script>
</body>
</html>