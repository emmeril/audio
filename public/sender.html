<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Stream - Pengirim</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen">
    <div x-data="senderApp()" class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">ğŸ¤ Pengirim Audio</h1>
                <p class="text-gray-600">Bagikan audio dari YouTube Music atau aplikasi lainnya</p>
            </div>
            <a href="/" class="bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-gray-900 transition">
                â† Kembali
            </a>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Control Panel -->
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                    <span class="mr-2">âš™ï¸</span> Kontrol Streaming
                </h2>

                <!-- Room Info -->
                <div class="mb-6 p-4 bg-blue-50 rounded-lg" x-show="roomCode">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm text-blue-600">Kode Room:</p>
                            <p class="text-2xl font-bold text-blue-800" x-text="roomCode"></p>
                            <p class="text-sm text-blue-600 mt-1">
                                <span x-text="connectedUsers"></span> pendengar terhubung
                            </p>
                        </div>
                        <button @click="copyRoomCode()"
                                class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-200 transition">
                            ğŸ“‹ Salin
                        </button>
                    </div>
                </div>

                <!-- Instructions -->
                <div class="mb-6 p-4 bg-yellow-50 rounded-lg">
                    <h3 class="font-semibold text-yellow-800 mb-2">ğŸ“‹ Cara Menggunakan:</h3>
                    <ol class="list-decimal pl-5 text-yellow-700 space-y-1 text-sm">
                        <li>Buka YouTube Music atau aplikasi musik di tab terpisah</li>
                        <li>Klik "Mulai Streaming" di bawah</li>
                        <li>Pilih "Share audio" saat memilih layar/tab yang akan dibagikan</li>
                        <li>Bagikan kode room ke pendengar</li>
                    </ol>
                </div>

                <!-- Buttons -->
                <div class="space-y-4">
                    <button @click="startStreaming()"
                            :disabled="isStreaming"
                            :class="isStreaming ? 'bg-green-600' : 'bg-blue-600 hover:bg-blue-700'"
                            class="w-full text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                        <span class="mr-2" x-text="isStreaming ? 'ğŸ”´' : 'â–¶ï¸'"></span>
                        <span x-text="isStreaming ? 'Streaming Aktif' : 'Mulai Streaming'"></span>
                    </button>

                    <button @click="stopStreaming()"
                            :disabled="!isStreaming"
                            :class="isStreaming ? 'bg-red-600 hover:bg-red-700' : 'bg-gray-400'"
                            class="w-full text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                        â¹ï¸ Berhenti Streaming
                    </button>
                </div>

                <!-- Status -->
                <div class="mt-6 p-4 rounded-lg" :class="statusClass">
                    <p class="font-semibold" x-text="statusMessage"></p>
                    <p class="text-sm mt-1" x-text="statusDescription"></p>
                </div>
            </div>

            <!-- Preview & Info -->
            <div class="space-y-8">
                <!-- Preview -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">ğŸ‘ï¸ Preview</h2>
                    <div class="aspect-video bg-gray-900 rounded-lg overflow-hidden">
                        <video x-ref="previewVideo" 
                               autoplay 
                               muted
                               class="w-full h-full object-contain">
                        </video>
                    </div>
                    <p class="text-sm text-gray-500 mt-2 text-center" x-show="!isStreaming">
                        Preview akan muncul setelah memulai streaming
                    </p>
                </div>

                <!-- Connected Users -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">ğŸ‘¥ Pendengar Terhubung</h2>
                    <div class="space-y-2">
                        <template x-for="user in listeners" :key="user">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                                    <span class="text-gray-700" x-text="'Pendengar ' + user.substring(0, 8)"></span>
                                </div>
                                <span class="text-sm text-gray-500">Online</span>
                            </div>
                        </template>
                        <p class="text-gray-500 text-center p-4" x-show="listeners.length === 0">
                            Belum ada pendengar yang terhubung
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function senderApp() {
            return {
                socket: null,
                roomCode: '',
                isStreaming: false,
                peerConnections: new Map(),
                listeners: [],
                connectedUsers: 0,
                stream: null,
                
                statusMessage: 'Siap untuk memulai streaming',
                statusDescription: 'Klik "Mulai Streaming" untuk berbagi audio dari komputer Anda',
                statusClass: 'bg-gray-100 text-gray-700',
                
                async init() {
                    // Generate random room code
                    this.roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                    
                    // Connect to Socket.io
                    this.socket = io();
                    
                    // Join room
                    this.socket.emit('join-room', this.roomCode);
                    
                    // Listen for new listeners
                    this.socket.on('sdp-answer', async (data) => {
                        const pc = this.peerConnections.get(this.socket.id);
                        if (pc) {
                            await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                        }
                    });
                    
                    this.socket.on('ice-candidate', async (data) => {
                        const pc = this.peerConnections.get(this.socket.id);
                        if (pc) {
                            await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                        }
                    });
                    
                    this.socket.on('user-joined', (userId) => {
                        this.listeners.push(userId);
                        this.connectedUsers = this.listeners.length;
                        this.updateStatus(`${userId} bergabung`, 'bg-green-100 text-green-700');
                    });
                    
                    this.socket.on('user-left', (userId) => {
                        this.listeners = this.listeners.filter(id => id !== userId);
                        this.connectedUsers = this.listeners.length;
                        this.updateStatus(`${userId} keluar`, 'bg-yellow-100 text-yellow-700');
                    });
                },
                
                async startStreaming() {
                    try {
                        this.updateStatus('Mengambil izin screen sharing...', 'bg-blue-100 text-blue-700');
                        
                        // Get screen sharing stream with audio
                        const constraints = {
                            video: true,
                            audio: {
                                echoCancellation: false,
                                noiseSuppression: false,
                                autoGainControl: false
                            }
                        };
                        
                        this.stream = await navigator.mediaDevices.getDisplayMedia(constraints);
                        
                        // Show preview
                        this.$refs.previewVideo.srcObject = this.stream;
                        
                        this.isStreaming = true;
                        this.updateStatus('Streaming aktif!', 'bg-green-100 text-green-700');
                        
                        // Create peer connections for existing listeners
                        this.createPeerConnections();
                        
                    } catch (error) {
                        console.error('Error starting stream:', error);
                        this.updateStatus('Gagal memulai streaming: ' + error.message, 'bg-red-100 text-red-700');
                    }
                },
                
                async createPeerConnections() {
                    // Create RTCPeerConnection for each listener
                    const configuration = {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:global.stun.twilio.com:3478' }
                        ]
                    };
                    
                    for (const listener of this.listeners) {
                        const pc = new RTCPeerConnection(configuration);
                        
                        // Add local stream tracks
                        this.stream.getTracks().forEach(track => {
                            pc.addTrack(track, this.stream);
                        });
                        
                        // Handle ICE candidates
                        pc.onicecandidate = (event) => {
                            if (event.candidate) {
                                this.socket.emit('ice-candidate', {
                                    roomId: this.roomCode,
                                    candidate: event.candidate,
                                    to: listener
                                });
                            }
                        };
                        
                        // Create and send offer
                        const offer = await pc.createOffer();
                        await pc.setLocalDescription(offer);
                        
                        this.socket.emit('sdp-offer', {
                            roomId: this.roomCode,
                            offer: offer,
                            to: listener
                        });
                        
                        this.peerConnections.set(listener, pc);
                    }
                },
                
                stopStreaming() {
                    if (this.stream) {
                        this.stream.getTracks().forEach(track => track.stop());
                        this.stream = null;
                    }
                    
                    this.$refs.previewVideo.srcObject = null;
                    this.isStreaming = false;
                    
                    // Close all peer connections
                    this.peerConnections.forEach(pc => pc.close());
                    this.peerConnections.clear();
                    
                    this.updateStatus('Streaming dihentikan', 'bg-gray-100 text-gray-700');
                },
                
                copyRoomCode() {
                    navigator.clipboard.writeText(this.roomCode);
                    alert(`Kode room ${this.roomCode} disalin!`);
                },
                
                updateStatus(message, description = '', className = 'bg-blue-100 text-blue-700') {
                    this.statusMessage = message;
                    this.statusDescription = description || this.statusDescription;
                    this.statusClass = className;
                }
            }
        }
    </script>
</body>
</html>