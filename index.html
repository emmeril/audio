<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Video Stream App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .audio-wave {
            display: flex;
            align-items: flex-end;
            height: 40px;
        }
        
        .wave-bar {
            width: 3px;
            margin: 0 1px;
            background: linear-gradient(to top, #10b981, #3b82f6);
            border-radius: 2px;
            animation: wave 1.5s ease-in-out infinite;
        }
        
        @keyframes wave {
            0%, 100% { height: 10px; }
            50% { height: 40px; }
        }
        
        .live-indicator {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .video-container {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
    </style>
</head>
<body class="min-h-screen">
    <div x-data="streamApp()" x-init="init()" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="glass-effect border-b border-white/20 py-4">
            <div class="container mx-auto px-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                            <span class="text-2xl">üé¨</span>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-white">Stream Hub</h1>
                            <p class="text-white/80 text-sm">Stream audio & video real-time</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="text-white">
                            <div class="flex items-center space-x-2 bg-white/10 px-3 py-2 rounded-lg">
                                <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                <span class="text-sm" x-text="serverStatus"></span>
                            </div>
                        </div>
                        
                        <div class="hidden md:block">
                            <div class="flex items-center space-x-2 text-white/80">
                                <span class="text-sm">Stream Aktif:</span>
                                <span class="bg-red-500 text-white px-2 py-1 rounded-full text-xs font-bold" 
                                      x-text="activeStreams.length"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content - Berdasarkan Mode -->
        <main class="flex-1 p-4">
            <div class="w-full max-w-6xl mx-auto">
                
                <!-- Mode: Home/Landing Page -->
                <template x-if="appMode === 'home'">
                    <div class="space-y-8">
                        <!-- Hero Section -->
                        <div class="text-center pt-8">
                            <h2 class="text-4xl md:text-5xl font-bold text-white mb-4">
                                Streaming <span class="text-yellow-300">Audio & Video</span> Bersama
                            </h2>
                            <p class="text-xl text-white/80 max-w-2xl mx-auto">
                                Bagikan layar, audio, atau webcam Anda ke banyak orang secara real-time
                            </p>
                        </div>

                        <!-- Active Streams -->
                        <div x-show="activeStreams.length > 0" class="fade-in">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h3 class="text-2xl font-bold text-white">üî• Live Sekarang</h3>
                                    <p class="text-white/80">Gabung ke streaming yang sedang berlangsung</p>
                                </div>
                                <button @click="fetchActiveStreams()" 
                                        class="bg-white/10 hover:bg-white/20 text-white p-2 rounded-lg transition">
                                    üîÑ
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <template x-for="stream in activeStreams" :key="stream.roomId">
                                    <div class="bg-white/90 backdrop-blur-sm rounded-2xl p-6 hover:shadow-xl transition">
                                        <div class="flex items-start justify-between mb-4">
                                            <div>
                                                <div class="flex items-center mb-2">
                                                    <div class="bg-red-500 text-white px-3 py-1 rounded-full mr-3 text-xs font-bold">
                                                        LIVE
                                                    </div>
                                                    <span class="text-xs text-gray-500" 
                                                          x-text="formatTimeAgo(stream.startedAt)"></span>
                                                </div>
                                                <h4 class="text-xl font-bold text-gray-800" x-text="stream.roomId"></h4>
                                                <p class="text-gray-600 text-sm mt-1">
                                                    <span x-text="stream.hasVideo ? 'üìπ Video' : 'üéµ Audio'"></span>
                                                    ‚Ä¢ <span x-text="stream.listenersCount + ' pendengar'"></span>
                                                </p>
                                            </div>
                                            <div class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">
                                                <span x-text="stream.listenersCount"></span> üë•
                                            </div>
                                        </div>
                                        
                                        <div class="space-y-2 mb-6">
                                            <div class="flex items-center text-sm text-gray-600">
                                                <span class="mr-2">üëë</span>
                                                <span>Host: <span class="font-mono" x-text="stream.hostId.substring(0, 8) + '...'"></span></span>
                                            </div>
                                            <div class="flex items-center text-sm text-gray-600">
                                                <span class="mr-2">‚è±Ô∏è</span>
                                                <span x-text="'Durasi: ' + formatDuration(stream.startedAt)"></span>
                                            </div>
                                        </div>
                                        
                                        <button @click="joinAsListener(stream.roomId)"
                                                class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-semibold py-3 rounded-xl transition flex items-center justify-center">
                                            <span class="mr-2">üéß</span>
                                            Gabung Sekarang
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Action Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-8">
                            <!-- Host Card -->
                            <div class="bg-white/90 backdrop-blur-sm rounded-2xl p-8">
                                <div class="flex items-center mb-6">
                                    <div class="w-14 h-14 bg-blue-100 rounded-xl flex items-center justify-center mr-4">
                                        <span class="text-3xl">üé§</span>
                                    </div>
                                    <div>
                                        <h3 class="text-2xl font-bold text-gray-800">Jadi Host</h3>
                                        <p class="text-gray-600">Mulai streaming audio & video</p>
                                    </div>
                                </div>
                                
                                <div class="space-y-4 mb-6">
                                    <div class="flex items-start">
                                        <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center mr-3 mt-1">
                                            <span class="text-blue-600">1</span>
                                        </div>
                                        <p class="text-gray-700">Pilih sumber (layar, webcam, atau audio saja)</p>
                                    </div>
                                    <div class="flex items-start">
                                        <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center mr-3 mt-1">
                                            <span class="text-blue-600">2</span>
                                        </div>
                                        <p class="text-gray-700">Streaming langsung dimulai</p>
                                    </div>
                                    <div class="flex items-start">
                                        <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center mr-3 mt-1">
                                            <span class="text-blue-600">3</span>
                                        </div>
                                        <p class="text-gray-700">Undang orang dengan kode room</p>
                                    </div>
                                </div>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Kode Room</label>
                                        <input x-model="roomCodeInput" 
                                               type="text" 
                                               placeholder="Kosongkan untuk buat otomatis"
                                               class="w-full px-4 py-3 border-2 border-blue-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                                    </div>
                                    
                                    <div class="space-y-3">
                                        <button @click="startAsHost('screen')"
                                                class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold py-3 rounded-xl transition">
                                            üñ•Ô∏è Share Layar + Audio
                                        </button>
                                        
                                        <button @click="startAsHost('camera')"
                                                class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-semibold py-3 rounded-xl transition">
                                            üì∑ Webcam + Audio
                                        </button>
                                        
                                        <button @click="startAsHost('audio-only')"
                                                class="w-full bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-semibold py-3 rounded-xl transition">
                                            üéµ Audio Saja
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Listener Card -->
                            <div class="bg-white/90 backdrop-blur-sm rounded-2xl p-8">
                                <div class="flex items-center mb-6">
                                    <div class="w-14 h-14 bg-purple-100 rounded-xl flex items-center justify-center mr-4">
                                        <span class="text-3xl">üéß</span>
                                    </div>
                                    <div>
                                        <h3 class="text-2xl font-bold text-gray-800">Jadi Pendengar</h3>
                                        <p class="text-gray-600">Gabung ke streaming</p>
                                    </div>
                                </div>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Kode Room</label>
                                        <input x-model="joinRoomCode" 
                                               type="text" 
                                               placeholder="Masukkan kode room"
                                               @keyup.enter="joinAsListener(joinRoomCode)"
                                               class="w-full px-4 py-3 border-2 border-purple-200 rounded-xl focus:border-purple-500 focus:ring-2 focus:ring-purple-200">
                                    </div>
                                    
                                    <button @click="joinAsListener(joinRoomCode)"
                                            class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-semibold py-3 rounded-xl transition">
                                        üéß Gabung Room
                                    </button>
                                    
                                    <div class="text-center">
                                        <button @click="generateRandomRoom()"
                                                class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                            üé≤ Generate Kode Random
                                        </button>
                                    </div>
                                    
                                    <div x-show="activeStreams.length > 0" class="pt-4 border-t border-gray-200">
                                        <p class="text-sm text-gray-600 mb-3">Atau pilih dari streaming aktif:</p>
                                        <div class="space-y-2">
                                            <template x-for="stream in activeStreams.slice(0, 3)" :key="stream.roomId">
                                                <button @click="joinAsListener(stream.roomId)"
                                                        class="w-full text-left p-3 bg-purple-50 hover:bg-purple-100 rounded-lg transition flex items-center justify-between">
                                                    <div class="flex items-center">
                                                        <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse mr-3"></div>
                                                        <span class="font-semibold text-gray-800" x-text="stream.roomId"></span>
                                                    </div>
                                                    <span class="text-sm text-gray-500" x-text="stream.listenersCount + ' üë•'"></span>
                                                </button>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Mode: Host Streaming -->
                <template x-if="appMode === 'host'">
                    <div class="space-y-6">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center space-x-3">
                                <button @click="appMode = 'home'" 
                                        class="flex items-center space-x-2 text-white hover:text-white/80 transition">
                                    <span class="text-2xl">‚Üê</span>
                                    <span>Kembali</span>
                                </button>
                                <div class="h-6 w-px bg-white/30"></div>
                                <div>
                                    <h2 class="text-2xl font-bold text-white">üé§ Host Streaming</h2>
                                    <p class="text-white/80 text-sm">Room: <span x-text="currentRoom" class="font-bold"></span></p>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-4">
                                <div class="glass-effect px-4 py-2 rounded-lg">
                                    <div class="flex items-center">
                                        <div class="status-indicator bg-green-400 animate-pulse"></div>
                                        <span class="text-white text-sm" x-text="listeners.size + ' pendengar'"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Video Preview -->
                            <div class="lg:col-span-2">
                                <div class="video-container">
                                    <video x-ref="localVideo" 
                                           autoplay 
                                           muted
                                           playsinline
                                           class="w-full h-auto max-h-[500px]">
                                    </video>
                                    
                                    <div x-show="!isStreaming" class="absolute inset-0 flex items-center justify-center">
                                        <div class="text-center p-8">
                                            <div class="text-6xl mb-4 opacity-30">üé¨</div>
                                            <p class="text-white text-lg font-semibold">Streaming Preview</p>
                                            <p class="text-white/70">Mulai streaming untuk melihat preview</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-4 bg-white rounded-xl p-6">
                                    <h3 class="text-xl font-bold text-gray-800 mb-4">üéõÔ∏è Kontrol Streaming</h3>
                                    <div class="flex space-x-4">
                                        <button @click="toggleStreaming()"
                                                :class="isStreaming ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'"
                                                class="flex-1 text-white font-semibold py-3 px-6 rounded-xl transition">
                                            <span x-text="isStreaming ? '‚èπÔ∏è Stop Streaming' : '‚ñ∂Ô∏è Start Streaming'"></span>
                                        </button>
                                        
                                        <button @click="copyRoomLink()"
                                                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition">
                                            üìã Salin Link
                                        </button>
                                        
                                        <button @click="toggleAudio()"
                                                class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-xl transition">
                                            <span x-text="audioMuted ? 'üîà Unmute' : 'üîá Mute'"></span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Listeners Panel -->
                            <div class="bg-white rounded-2xl p-6">
                                <h3 class="text-xl font-bold text-gray-800 mb-6">üë• Pendengar</h3>
                                
                                <div class="space-y-3 max-h-[400px] overflow-y-auto">
                                    <template x-for="listenerId in Array.from(listeners)" :key="listenerId">
                                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                            <div class="flex items-center">
                                                <div class="w-3 h-3 bg-green-500 rounded-full mr-3 animate-pulse"></div>
                                                <div>
                                                    <p class="font-semibold text-gray-800" x-text="'Pendengar ' + listenerId.substring(0, 8)"></p>
                                                    <p class="text-xs text-gray-500">Connected</p>
                                                </div>
                                            </div>
                                            <div class="audio-wave">
                                                <template x-for="i in 5" :key="i">
                                                    <div class="wave-bar" :style="`animation-delay: ${i*0.1}s`"></div>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                    
                                    <div x-show="listeners.size === 0" class="text-center p-6">
                                        <div class="text-4xl mb-4 text-gray-300">üëÇ</div>
                                        <p class="text-gray-500 font-medium">Belum ada pendengar</p>
                                        <p class="text-gray-400 text-sm mt-1">Bagikan kode room untuk mengundang</p>
                                    </div>
                                </div>
                                
                                <!-- Room Info -->
                                <div class="mt-6 pt-6 border-t border-gray-200">
                                    <div class="space-y-3">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Kode Room</span>
                                            <span class="font-bold text-gray-800" x-text="currentRoom"></span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Status</span>
                                            <span class="font-semibold text-green-600" x-text="isStreaming ? 'Live' : 'Ready'"></span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Durasi</span>
                                            <span class="font-semibold text-gray-800" x-text="streamDuration"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Mode: Listener -->
                <template x-if="appMode === 'listener'">
                    <div class="space-y-6">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center space-x-3">
                                <button @click="appMode = 'home'" 
                                        class="flex items-center space-x-2 text-white hover:text-white/80 transition">
                                    <span class="text-2xl">‚Üê</span>
                                    <span>Kembali</span>
                                </button>
                                <div class="h-6 w-px bg-white/30"></div>
                                <div>
                                    <h2 class="text-2xl font-bold text-white">üéß Mode Pendengar</h2>
                                    <p class="text-white/80 text-sm">Room: <span x-text="currentRoom" class="font-bold"></span></p>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-4">
                                <div class="glass-effect px-4 py-2 rounded-lg">
                                    <div class="flex items-center">
                                        <div :class="isConnected ? 'bg-green-400 animate-pulse' : 'bg-red-400'"
                                             class="status-indicator"></div>
                                        <span class="text-white text-sm" x-text="isConnected ? 'Connected' : 'Connecting'"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Remote Video -->
                            <div class="lg:col-span-2">
                                <div class="video-container">
                                    <video x-ref="remoteVideo" 
                                           autoplay 
                                           playsinline
                                           class="w-full h-auto max-h-[500px]">
                                    </video>
                                    
                                    <div x-show="!hasStream" class="absolute inset-0 flex items-center justify-center">
                                        <div class="text-center p-8">
                                            <div class="text-6xl mb-4 opacity-30">üì°</div>
                                            <p class="text-white text-lg font-semibold">Menunggu Stream</p>
                                            <p class="text-white/70">Host belum memulai streaming</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Controls -->
                                <div class="mt-4 bg-white rounded-xl p-6">
                                    <h3 class="text-xl font-bold text-gray-800 mb-4">üéöÔ∏è Kontrol Audio</h3>
                                    <div class="flex items-center space-x-6">
                                        <div class="flex-1">
                                            <div class="flex items-center justify-between mb-2">
                                                <span class="text-gray-700 font-medium">Volume</span>
                                                <span class="text-blue-600 font-bold" x-text="volume + '%'"></span>
                                            </div>
                                            <input type="range" 
                                                   x-model="volume" 
                                                   @input="updateVolume($event.target.value)"
                                                   min="0" 
                                                   max="100" 
                                                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                        </div>
                                        
                                        <button @click="toggleMute()"
                                                :class="isMuted ? 'bg-red-600' : 'bg-gray-600'"
                                                class="text-white font-semibold py-3 px-6 rounded-xl transition">
                                            <span x-text="isMuted ? 'üîà Unmute' : 'üîá Mute'"></span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Connection Info -->
                            <div class="bg-white rounded-2xl p-6">
                                <h3 class="text-xl font-bold text-gray-800 mb-6">‚ÑπÔ∏è Info Koneksi</h3>
                                
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                        <span class="text-gray-700">Status</span>
                                        <span class="font-semibold" :class="connectionState === 'connected' ? 'text-green-600' : 'text-yellow-600'"
                                              x-text="connectionState"></span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                        <span class="text-gray-700">Kode Room</span>
                                        <span class="font-semibold text-blue-600" x-text="currentRoom"></span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                        <span class="text-gray-700">Host ID</span>
                                        <span class="font-semibold text-gray-800" x-text="hostId ? hostId.substring(0, 8) + '...' : '-'"></span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                        <span class="text-gray-700">Audio Track</span>
                                        <span class="font-semibold" :class="hasAudio ? 'text-green-600' : 'text-red-600'"
                                              x-text="hasAudio ? 'Active' : 'None'"></span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                        <span class="text-gray-700">Video Track</span>
                                        <span class="font-semibold" :class="hasVideo ? 'text-green-600' : 'text-red-600'"
                                              x-text="hasVideo ? 'Active' : 'None'"></span>
                                    </div>
                                </div>
                                
                                <!-- Stats -->
                                <div class="mt-6 pt-6 border-t border-gray-200">
                                    <h4 class="font-bold text-gray-700 mb-4">üìà Statistik</h4>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="text-center p-3 bg-blue-50 rounded-lg">
                                            <p class="text-2xl font-bold text-blue-600" x-text="bytesReceived"></p>
                                            <p class="text-sm text-gray-600">Data Received</p>
                                        </div>
                                        <div class="text-center p-3 bg-purple-50 rounded-lg">
                                            <p class="text-2xl font-bold text-purple-600" x-text="connectionTime"></p>
                                            <p class="text-sm text-gray-600">Durasi</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <button @click="reconnect()"
                                        class="w-full mt-6 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold py-3 rounded-xl transition">
                                    üîÅ Sambung Ulang
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </main>

        <!-- Status Bar -->
        <div class="bg-black/80 backdrop-blur-sm text-white py-2 px-4 mt-auto">
            <div class="container mx-auto">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <div class="status-indicator" :class="statusColor"></div>
                            <span class="text-sm" x-text="statusMessage"></span>
                        </div>
                        <div class="text-sm opacity-75 hidden md:block" x-text="statusDetail"></div>
                    </div>
                    <div class="text-sm opacity-75">
                        <span x-text="new Date().toLocaleTimeString('id-ID')"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden Audio Element for Listener -->
        <audio x-ref="remoteAudio" 
               autoplay
               playsinline
               class="hidden">
        </audio>
    </div>

    <!-- Alpine.js Application Logic -->
    <script>
        function streamApp() {
            return {
                // App State
                appMode: 'home',
                serverStatus: 'Connecting...',
                
                // Home State
                activeStreams: [],
                roomCodeInput: '',
                joinRoomCode: '',
                
                // Host State
                currentRoom: '',
                isStreaming: false,
                listeners: new Set(),
                audioMuted: false,
                streamStartTime: null,
                streamDuration: '00:00',
                hostInterval: null,
                
                // Listener State
                isConnected: false,
                hasStream: false,
                hasAudio: false,
                hasVideo: false,
                connectionState: 'disconnected',
                volume: 80,
                isMuted: false,
                hostId: null,
                bytesReceived: 0,
                connectionStartTime: null,
                connectionTime: '00:00',
                
                // WebRTC
                socket: null,
                localStream: null,
                peerConnections: new Map(),
                remoteStream: null,
                
                // Status
                statusMessage: 'Ready',
                statusDetail: '',
                statusColor: 'bg-green-500',
                
                // Initialization
                async init() {
                    console.log('üöÄ Stream App Initializing...');
                    
                    // Initialize Socket
                    this.initializeSocket();
                    
                    // Fetch active streams
                    this.fetchActiveStreams();
                    
                    // Set up interval to update active streams
                    setInterval(() => this.fetchActiveStreams(), 10000);
                    
                    // Update time
                    setInterval(() => {
                        if (this.streamStartTime && this.isStreaming) {
                            this.updateStreamDuration();
                        }
                        if (this.connectionStartTime && this.isConnected) {
                            this.updateConnectionTime();
                        }
                    }, 1000);
                },
                
                // Socket Initialization
                initializeSocket() {
                    try {
                        this.socket = io({
                            transports: ['websocket', 'polling'],
                            reconnection: true,
                            reconnectionAttempts: 5,
                            reconnectionDelay: 1000
                        });
                        
                        this.socket.on('connect', () => {
                            console.log('‚úÖ Socket connected:', this.socket.id);
                            this.serverStatus = 'Connected';
                            this.updateStatus('Connected to server', 'bg-green-500');
                        });
                        
                        this.socket.on('connect_error', (error) => {
                            console.error('Socket connection error:', error);
                            this.serverStatus = 'Disconnected';
                            this.updateStatus('Connection error', 'bg-red-500', error.message);
                        });
                        
                        this.socket.on('disconnect', () => {
                            this.serverStatus = 'Disconnected';
                            this.updateStatus('Disconnected from server', 'bg-red-500');
                        });
                        
                        // Listen for active streams list
                        this.socket.on('active-streams-list', (data) => {
                            this.activeStreams = data.activeRooms || [];
                        });
                        
                        // Listen for new streaming room
                        this.socket.on('streaming-room-added', (data) => {
                            this.fetchActiveStreams();
                        });
                        
                        // Listen for removed streaming room
                        this.socket.on('streaming-room-removed', (data) => {
                            this.fetchActiveStreams();
                        });
                        
                        // Host: New listener joined
                        this.socket.on('new-listener', (data) => {
                            console.log('New listener:', data.listenerId);
                            this.listeners.add(data.listenerId);
                            this.updateStatus('New listener joined', 'bg-blue-500');
                            
                            // Create peer connection for new listener
                            if (this.isStreaming && this.localStream) {
                                this.createPeerConnection(data.listenerId);
                            }
                        });
                        
                        // Host: Listener left
                        this.socket.on('listener-left', (data) => {
                            this.listeners.delete(data.listenerId);
                            
                            // Close peer connection
                            const pc = this.peerConnections.get(data.listenerId);
                            if (pc) {
                                pc.close();
                                this.peerConnections.delete(data.listenerId);
                            }
                        });
                        
                        // Listener: Received SDP offer
                        this.socket.on('sdp-offer', async (data) => {
                            console.log('Received SDP offer from:', data.senderId);
                            this.hostId = data.senderId;
                            
                            await this.handleOffer(data.offer);
                        });
                        
                        // Listener: Received ICE candidate
                        this.socket.on('ice-candidate', async (data) => {
                            if (this.peerConnection && data.candidate) {
                                try {
                                    await this.peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                                } catch (error) {
                                    console.error('Error adding ICE candidate:', error);
                                }
                            }
                        });
                        
                        // Listener: Host started streaming
                        this.socket.on('host-streaming-started', (data) => {
                            console.log('Host started streaming');
                            this.updateStatus('Host started streaming', 'bg-green-500');
                        });
                        
                        // Listener: Host stopped streaming
                        this.socket.on('host-streaming-stopped', () => {
                            console.log('Host stopped streaming');
                            this.updateStatus('Host stopped streaming', 'bg-yellow-500');
                            this.stopListenerStream();
                        });
                        
                        // Listener: Host disconnected
                        this.socket.on('host-disconnected', () => {
                            console.log('Host disconnected');
                            this.updateStatus('Host disconnected', 'bg-red-500');
                            this.stopListenerStream();
                            this.appMode = 'home';
                        });
                        
                    } catch (error) {
                        console.error('Error initializing socket:', error);
                    }
                },
                
                // Fetch active streams
                async fetchActiveStreams() {
                    try {
                        this.socket.emit('get-active-streams');
                    } catch (error) {
                        console.error('Error fetching active streams:', error);
                    }
                },
                
                // Host: Start as Host
                async startAsHost(streamType) {
                    try {
                        // Generate or use room code
                        const roomCode = this.roomCodeInput.trim() || this.generateRoomCode();
                        this.currentRoom = roomCode.toUpperCase();
                        this.roomCodeInput = '';
                        
                        // Join room as host
                        this.socket.emit('join-room', this.currentRoom, 'host');
                        
                        // Get media stream based on type
                        await this.getMediaStream(streamType);
                        
                        // Switch to host mode
                        this.appMode = 'host';
                        this.updateStatus(`Host mode - Room: ${this.currentRoom}`, 'bg-blue-500');
                        
                    } catch (error) {
                        console.error('Error starting as host:', error);
                        this.updateStatus('Failed to start streaming', 'bg-red-500', error.message);
                    }
                },
                
                // Get Media Stream
                async getMediaStream(type) {
                    try {
                        const constraints = {
                            audio: {
                                echoCancellation: false,
                                noiseSuppression: false,
                                autoGainControl: false,
                                channelCount: 2,
                                sampleRate: 48000
                            },
                            video: false
                        };
                        
                        if (type === 'screen') {
                            // Screen sharing with audio
                            const screenStream = await navigator.mediaDevices.getDisplayMedia({
                                video: { cursor: 'always' },
                                audio: true
                            });
                            
                            // Try to get system audio separately if needed
                            constraints.video = false;
                            const audioStream = await navigator.mediaDevices.getUserMedia(constraints);
                            
                            // Combine streams
                            this.localStream = new MediaStream([
                                ...screenStream.getVideoTracks(),
                                ...audioStream.getAudioTracks()
                            ]);
                            
                        } else if (type === 'camera') {
                            // Webcam with audio
                            constraints.video = {
                                width: { ideal: 1280 },
                                height: { ideal: 720 },
                                frameRate: { ideal: 30 }
                            };
                            this.localStream = await navigator.mediaDevices.getUserMedia(constraints);
                            
                        } else if (type === 'audio-only') {
                            // Audio only
                            this.localStream = await navigator.mediaDevices.getUserMedia(constraints);
                        }
                        
                        // Display local video if available
                        if (this.localStream.getVideoTracks().length > 0) {
                            this.$refs.localVideo.srcObject = this.localStream;
                        }
                        
                    } catch (error) {
                        console.error('Error getting media stream:', error);
                        throw error;
                    }
                },
                
                // Host: Toggle Streaming
                async toggleStreaming() {
                    if (!this.isStreaming) {
                        // Start streaming
                        await this.startStreaming();
                    } else {
                        // Stop streaming
                        this.stopStreaming();
                    }
                },
                
                // Host: Start Streaming
                async startStreaming() {
                    if (!this.localStream) {
                        this.updateStatus('No media stream available', 'bg-red-500');
                        return;
                    }
                    
                    try {
                        this.isStreaming = true;
                        this.streamStartTime = new Date();
                        
                        // Notify server
                        this.socket.emit('host-started-streaming', this.currentRoom);
                        
                        this.updateStatus('Streaming started', 'bg-green-500', `Room: ${this.currentRoom}`);
                        
                        // Update duration timer
                        this.hostInterval = setInterval(() => {
                            this.updateStreamDuration();
                        }, 1000);
                        
                    } catch (error) {
                        console.error('Error starting streaming:', error);
                        this.isStreaming = false;
                    }
                },
                
                // Host: Stop Streaming
                stopStreaming() {
                    this.isStreaming = false;
                    this.streamStartTime = null;
                    
                    // Stop all tracks
                    if (this.localStream) {
                        this.localStream.getTracks().forEach(track => track.stop());
                        this.localStream = null;
                        this.$refs.localVideo.srcObject = null;
                    }
                    
                    // Close all peer connections
                    this.peerConnections.forEach(pc => pc.close());
                    this.peerConnections.clear();
                    
                    // Clear listeners
                    this.listeners.clear();
                    
                    // Clear interval
                    if (this.hostInterval) {
                        clearInterval(this.hostInterval);
                    }
                    
                    // Notify server
                    this.socket.emit('host-stopped-streaming', this.currentRoom);
                    
                    this.updateStatus('Streaming stopped', 'bg-gray-500');
                },
                
                // Host: Create Peer Connection for Listener
                async createPeerConnection(listenerId) {
                    try {
                        const configuration = {
                            iceServers: [
                                { urls: 'stun:stun.l.google.com:19302' },
                                { urls: 'stun:stun1.l.google.com:19302' }
                            ]
                        };
                        
                        const pc = new RTCPeerConnection(configuration);
                        
                        // Add local tracks
                        if (this.localStream) {
                            this.localStream.getTracks().forEach(track => {
                                pc.addTrack(track, this.localStream);
                            });
                        }
                        
                        // ICE candidate handler
                        pc.onicecandidate = (event) => {
                            if (event.candidate) {
                                this.socket.emit('ice-candidate', {
                                    roomId: this.currentRoom,
                                    candidate: event.candidate,
                                    to: listenerId
                                });
                            }
                        };
                        
                        // Create and send offer
                        const offer = await pc.createOffer();
                        await pc.setLocalDescription(offer);
                        
                        this.socket.emit('sdp-offer', {
                            roomId: this.currentRoom,
                            offer: offer,
                            to: listenerId
                        });
                        
                        // Store connection
                        this.peerConnections.set(listenerId, pc);
                        
                    } catch (error) {
                        console.error('Error creating peer connection:', error);
                    }
                },
                
                // Listener: Join as Listener
                async joinAsListener(roomCode) {
                    if (!roomCode) {
                        this.updateStatus('Please enter room code', 'bg-red-500');
                        return;
                    }
                    
                    try {
                        this.currentRoom = roomCode.toUpperCase();
                        this.joinRoomCode = '';
                        
                        // Join room as listener
                        this.socket.emit('join-room', this.currentRoom, 'listener');
                        
                        // Switch to listener mode
                        this.appMode = 'listener';
                        this.connectionStartTime = new Date();
                        this.isConnected = true;
                        this.connectionState = 'connecting';
                        
                        this.updateStatus(`Joining room: ${this.currentRoom}`, 'bg-blue-500');
                        
                    } catch (error) {
                        console.error('Error joining as listener:', error);
                        this.updateStatus('Failed to join room', 'bg-red-500', error.message);
                    }
                },
                
                // Listener: Handle SDP Offer
                async handleOffer(offer) {
                    try {
                        const configuration = {
                            iceServers: [
                                { urls: 'stun:stun.l.google.com:19302' },
                                { urls: 'stun:stun1.l.google.com:19302' }
                            ]
                        };
                        
                        this.peerConnection = new RTCPeerConnection(configuration);
                        
                        // Handle incoming tracks
                        this.peerConnection.ontrack = (event) => {
                            console.log('Received track:', event.track.kind);
                            
                            if (event.track.kind === 'audio') {
                                this.hasAudio = true;
                                this.$refs.remoteAudio.srcObject = event.streams[0];
                                this.$refs.remoteAudio.volume = this.volume / 100;
                                this.$refs.remoteAudio.muted = this.isMuted;
                            } else if (event.track.kind === 'video') {
                                this.hasVideo = true;
                                this.$refs.remoteVideo.srcObject = event.streams[0];
                            }
                            
                            this.hasStream = this.hasAudio || this.hasVideo;
                            this.connectionState = 'connected';
                            this.updateStatus('Stream received', 'bg-green-500');
                        };
                        
                        // ICE candidate handler
                        this.peerConnection.onicecandidate = (event) => {
                            if (event.candidate && this.hostId) {
                                this.socket.emit('ice-candidate', {
                                    roomId: this.currentRoom,
                                    candidate: event.candidate,
                                    to: this.hostId
                                });
                            }
                        };
                        
                        // ICE connection state
                        this.peerConnection.oniceconnectionstatechange = () => {
                            this.connectionState = this.peerConnection.iceConnectionState;
                            
                            if (this.connectionState === 'connected') {
                                this.isConnected = true;
                                this.updateStatus('Connected to host', 'bg-green-500');
                            } else if (this.connectionState === 'disconnected' || 
                                     this.connectionState === 'failed') {
                                this.updateStatus('Connection lost', 'bg-red-500');
                            }
                        };
                        
                        // Set remote description
                        await this.peerConnection.setRemoteDescription(
                            new RTCSessionDescription(offer)
                        );
                        
                        // Create and send answer
                        const answer = await this.peerConnection.createAnswer();
                        await this.peerConnection.setLocalDescription(answer);
                        
                        this.socket.emit('sdp-answer', {
                            roomId: this.currentRoom,
                            answer: answer,
                            to: this.hostId
                        });
                        
                    } catch (error) {
                        console.error('Error handling offer:', error);
                        this.updateStatus('Failed to handle offer', 'bg-red-500', error.message);
                    }
                },
                
                // Listener: Stop Stream
                stopListenerStream() {
                    this.hasStream = false;
                    this.hasAudio = false;
                    this.hasVideo = false;
                    this.isConnected = false;
                    
                    if (this.peerConnection) {
                        this.peerConnection.close();
                        this.peerConnection = null;
                    }
                    
                    this.$refs.remoteVideo.srcObject = null;
                    this.$refs.remoteAudio.srcObject = null;
                },
                
                // Listener: Reconnect
                reconnect() {
                    this.stopListenerStream();
                    this.joinAsListener(this.currentRoom);
                },
                
                // Helper Methods
                generateRoomCode() {
                    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                    let code = '';
                    for (let i = 0; i < 6; i++) {
                        code += chars.charAt(Math.floor(Math.random() * chars.length));
                    }
                    return code;
                },
                
                generateRandomRoom() {
                    const code = this.generateRoomCode();
                    this.joinRoomCode = code;
                    this.updateStatus(`Generated room code: ${code}`, 'bg-blue-500');
                },
                
                copyRoomLink() {
                    const link = `${window.location.origin}/?room=${this.currentRoom}`;
                    navigator.clipboard.writeText(link)
                        .then(() => {
                            this.updateStatus('Room link copied!', 'bg-green-500');
                        })
                        .catch(err => {
                            console.error('Failed to copy:', err);
                            this.updateStatus('Failed to copy link', 'bg-red-500');
                        });
                },
                
                toggleAudio() {
                    if (this.localStream) {
                        const audioTracks = this.localStream.getAudioTracks();
                        audioTracks.forEach(track => {
                            track.enabled = !track.enabled;
                        });
                        this.audioMuted = !this.audioMuted;
                        this.updateStatus(this.audioMuted ? 'Audio muted' : 'Audio unmuted', 
                                        this.audioMuted ? 'bg-yellow-500' : 'bg-green-500');
                    }
                },
                
                toggleMute() {
                    if (this.$refs.remoteAudio) {
                        this.isMuted = !this.isMuted;
                        this.$refs.remoteAudio.muted = this.isMuted;
                        this.updateStatus(this.isMuted ? 'Muted' : 'Unmuted', 
                                        this.isMuted ? 'bg-yellow-500' : 'bg-green-500');
                    }
                },
                
                updateVolume(value) {
                    this.volume = value;
                    if (this.$refs.remoteAudio) {
                        this.$refs.remoteAudio.volume = value / 100;
                    }
                },
                
                updateStreamDuration() {
                    if (!this.streamStartTime) return;
                    
                    const now = new Date();
                    const diff = Math.floor((now - this.streamStartTime) / 1000);
                    
                    const hours = Math.floor(diff / 3600);
                    const minutes = Math.floor((diff % 3600) / 60);
                    const seconds = diff % 60;
                    
                    this.streamDuration = 
                        (hours > 0 ? hours.toString().padStart(2, '0') + ':' : '') +
                        minutes.toString().padStart(2, '0') + ':' +
                        seconds.toString().padStart(2, '0');
                },
                
                updateConnectionTime() {
                    if (!this.connectionStartTime) return;
                    
                    const now = new Date();
                    const diff = Math.floor((now - this.connectionStartTime) / 1000);
                    
                    const minutes = Math.floor(diff / 60);
                    const seconds = diff % 60;
                    
                    this.connectionTime = 
                        minutes.toString().padStart(2, '0') + ':' +
                        seconds.toString().padStart(2, '0');
                },
                
                formatTimeAgo(timestamp) {
                    if (!timestamp) return 'Baru saja';
                    const now = Date.now();
                    const diff = now - timestamp;
                    const minutes = Math.floor(diff / (1000 * 60));
                    
                    if (minutes < 1) return 'Baru saja';
                    if (minutes === 1) return '1 menit lalu';
                    if (minutes < 60) return `${minutes} menit lalu`;
                    
                    const hours = Math.floor(minutes / 60);
                    if (hours === 1) return '1 jam lalu';
                    if (hours < 24) return `${hours} jam lalu`;
                    
                    const days = Math.floor(hours / 24);
                    return `${days} hari lalu`;
                },
                
                formatDuration(timestamp) {
                    if (!timestamp) return '0m';
                    const now = Date.now();
                    const diff = Math.floor((now - timestamp) / (1000 * 60));
                    
                    if (diff < 60) return `${diff}m`;
                    const hours = Math.floor(diff / 60);
                    const minutes = diff % 60;
                    return `${hours}h ${minutes}m`;
                },
                
                updateStatus(message, color = 'bg-blue-500', detail = '') {
                    this.statusMessage = message;
                    this.statusColor = color;
                    this.statusDetail = detail;
                    
                    // Auto-clear status after 5 seconds
                    setTimeout(() => {
                        if (this.statusMessage === message) {
                            this.statusMessage = 'Ready';
                            this.statusColor = 'bg-green-500';
                            this.statusDetail = '';
                        }
                    }, 5000);
                }
            };
        }
    </script>
</body>
</html>